<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>대시보드 - 디지털 출결관리</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: "#4F46E5",
              secondary: "#3730A3",
            },
            fontFamily: {
              sans: ["Inter", "sans-serif"],
            },
          },
        },
      };
    </script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css"
      rel="stylesheet"
    />
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="/favicon/apple-touch-icon.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="/favicon/favicon-32x32.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="/favicon/favicon-16x16.png"
    />
    <link rel="manifest" href="/manifest.json" />
    <meta name="theme-color" content="#4F46E5" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <meta name="apple-mobile-web-app-title" content="디지털 출결관리" />
  </head>
  <body class="bg-white text-gray-900 font-sans flex flex-col min-h-screen">
    <header>
      <nav
        class="container mx-auto px-4 sm:px-6 lg:px-8 py-2 sm:py-4 flex justify-between items-center"
      >
        <a
          href="/hub.html"
          class="text-xl sm:text-2xl font-bold text-primary flex items-center"
        >
          <i class="ri-calendar-check-fill mr-2"></i>
          디지털 출결관리
        </a>
        <button
          id="logoutButton"
          class="bg-secondary text-white px-4 py-2 rounded-lg"
        >
          로그아웃
        </button>
      </nav>
    </header>

    <main
      class="flex-grow flex items-center justify-center px-4 sm:px-6 lg:px-8 py-4 sm:py-8"
    >
      <div class="w-full max-w-2xl my-4 sm:my-8">
        <div class="bg-white overflow-hidden shadow-md rounded-lg p-6">
          <h2
            class="text-2xl sm:text-3xl font-bold mb-4 sm:mb-6 text-center text-gray-800"
          >
            출결 정보
          </h2>
          <div id="attendance-info" class="text-center">
            <!-- 출결 정보가 여기에 표시됩니다. -->
            로딩 중...
          </div>
        </div>
      </div>
    </main>

    <footer class="bg-white text-gray-600 py-4 mt-auto">
      <div class="container mx-auto px-4">
        <div class="flex flex-col items-center text-center">
          <h4 class="text-lg font-semibold mb-2">연락</h4>
          <p class="mb-2">이메일: ksb19558@naver.com</p>
          <a
            href="https://sungblab.vercel.app/blog"
            target="_blank"
            rel="noopener noreferrer"
            class="text-primary hover:underline mb-4"
            >개발자 블로그로 가기</a
          >
        </div>
        <div class="text-center">
          <p>&copy; 2024 디지털 출결관리. All rights reserved.</p>
        </div>
      </div>
    </footer>

    <script>
      // 토큰을 로컬 스토리지에서 가져오기
      let accessToken = localStorage.getItem("accessToken");
      const refreshToken = localStorage.getItem("refreshToken");

      // 로그아웃 기능
      document
        .getElementById("logoutButton")
        .addEventListener("click", async function () {
          try {
            const response = await fetch(
              "https://port-0-attend-backend-m0tl39wtc3a73922.sel4.cloudtype.app/api/logout",
              {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({
                  refreshToken: refreshToken,
                }),
              }
            );

            const data = await response.json();

            if (response.ok) {
              // 로컬 스토리지에서 토큰 제거
              localStorage.removeItem("accessToken");
              localStorage.removeItem("refreshToken");

              alert("로그아웃되었습니다.");
              window.location.href = "login.html";
            } else {
              alert(data.message || "로그아웃에 실패했습니다.");
            }
          } catch (error) {
            console.error("Error:", error);
            alert("서버 오류가 발생했습니다.");
          }
        });

      // 토큰 갱신 함수
      async function refreshAccessToken() {
        try {
          const response = await fetch(
            "https://port-0-attend-backend-m0tl39wtc3a73922.sel4.cloudtype.app/api/token",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                refreshToken: refreshToken,
              }),
            }
          );

          const data = await response.json();

          if (response.ok) {
            accessToken = data.accessToken;
            localStorage.setItem("accessToken", accessToken);
            return accessToken;
          } else {
            // 리프레시 토큰이 유효하지 않으면 로그아웃
            alert(data.message || "토큰 갱신에 실패했습니다.");
            localStorage.removeItem("accessToken");
            localStorage.removeItem("refreshToken");
            window.location.href = "login.html";
          }
        } catch (error) {
          console.error("Error:", error);
          alert("서버 오류가 발생했습니다.");
          window.location.href = "login.html";
        }
      }

      // API 요청 함수
      async function fetchWithAuth(url, options = {}) {
        // 기본 헤더에 엑세스 토큰 추가
        options.headers = options.headers || {};
        options.headers["Authorization"] = `Bearer ${accessToken}`;

        let response = await fetch(url, options);

        if (response.status === 401) {
          // 엑세스 토큰이 만료되었을 때
          accessToken = await refreshAccessToken();

          if (accessToken) {
            // 새로운 엑세스 토큰으로 다시 시도
            options.headers["Authorization"] = `Bearer ${accessToken}`;
            response = await fetch(url, options);
          }
        }

        return response;
      }

      // 출결 정보 가져오기
      async function loadAttendanceInfo() {
        try {
          const response = await fetchWithAuth(
            "https://port-0-attend-backend-m0tl39wtc3a73922.sel4.cloudtype.app/api/student-info",
            {
              method: "GET",
              headers: {
                "Content-Type": "application/json",
              },
            }
          );

          const data = await response.json();

          if (response.ok) {
            document.getElementById("attendance-info").innerHTML = `
              <p>학번: ${data.studentId}</p>
              <p>이름: ${data.name}</p>
              <!-- 추가적인 출결 정보를 여기에 표시 -->
            `;
          } else {
            document.getElementById("attendance-info").innerHTML = `
              <p>${data.message || "출결 정보를 불러오는 데 실패했습니다."}</p>
            `;
          }
        } catch (error) {
          console.error("Error:", error);
          document.getElementById("attendance-info").innerHTML = `
            <p>서버 오류가 발생했습니다.</p>
          `;
        }
      }

      // 페이지 로드 시 출결 정보 로드
      document.addEventListener("DOMContentLoaded", function () {
        if (!accessToken || !refreshToken) {
          // 토큰이 없으면 로그인 페이지로 리디렉션
          window.location.href = "login.html";
        } else {
          loadAttendanceInfo();
        }
      });
    </script>
  </body>
</html>
