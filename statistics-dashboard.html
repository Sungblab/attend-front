<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>디지털 출결관리</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment-timezone/0.5.33/moment-timezone-with-data.min.js"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: "#4F46E5",
              secondary: "#3730A3",
              accent: "#EEF2FF",
            },
            fontFamily: {
              sans: ["Inter", "sans-serif"],
            },
          },
        },
      };
    </script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css"
      rel="stylesheet"
    />
  </head>
  <body class="bg-gray-50">
    <header>
      <nav
        class="container mx-auto px-4 sm:px-6 lg:px-8 py-2 sm:py-4 flex justify-between items-center"
      >
        <a
          href="/hub.html"
          class="text-xl sm:text-2xl font-bold text-primary flex items-center"
        >
          <i class="ri-calendar-check-fill mr-2"></i>
          디지털 출결관리
        </a>
      </nav>
    </header>

    <main class="container mx-auto px-4 py-8">
      <section class="bg-white rounded-lg shadow mb-6 p-6">
        <h2 class="text-2xl font-bold mb-4">필터</h2>
        <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1"
              >시작일</label
            >
            <input
              type="date"
              id="startDate"
              class="w-full rounded-lg border-gray-300"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1"
              >종료일</label
            >
            <input
              type="date"
              id="endDate"
              class="w-full rounded-lg border-gray-300"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1"
              >학년</label
            >
            <select id="gradeSelect" class="w-full rounded-lg border-gray-300">
              <option value="">전체</option>
              <option value="1">1학년</option>
              <option value="2">2학년</option>
              <option value="3">3학년</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1"
              >반</label
            >
            <select id="classSelect" class="w-full rounded-lg border-gray-300">
              <option value="">전체</option>
              <option value="1">1반</option>
              <option value="2">2반</option>
              <option value="3">3반</option>
              <option value="4">4반</option>
              <option value="5">5반</option>
              <option value="6">6반</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1"
              >학번</label
            >
            <input
              type="text"
              id="studentIdInput"
              placeholder="학번 검색"
              class="w-full rounded-lg border-gray-300"
            />
          </div>
        </div>
        <div class="mt-4 flex justify-end">
          <button
            id="searchBtn"
            class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-secondary transition-colors"
          >
            <i class="ri-search-line mr-2"></i>검색
          </button>
        </div>
      </section>

      <section class="bg-white rounded-lg shadow mb-6 p-6">
        <h2 class="text-2xl font-bold mb-4">전체 통계</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-6 gap-4">
          <div class="bg-blue-50 p-4 rounded-lg">
            <h3 class="text-sm font-medium text-blue-700">전체 학생</h3>
            <p class="text-2xl font-bold text-blue-900" id="totalStudents">-</p>
          </div>
          <div class="bg-green-50 p-4 rounded-lg">
            <h3 class="text-sm font-medium text-green-700">출석률</h3>
            <p class="text-2xl font-bold text-green-900" id="attendanceRate">
              -
            </p>
          </div>
          <div class="bg-yellow-50 p-4 rounded-lg">
            <h3 class="text-sm font-medium text-yellow-700">지각률</h3>
            <p class="text-2xl font-bold text-yellow-900" id="lateRate">-</p>
          </div>
          <div class="bg-red-50 p-4 rounded-lg">
            <h3 class="text-sm font-medium text-red-700">결석률</h3>
            <p class="text-2xl font-bold text-red-900" id="absentRate">-</p>
          </div>
          <div class="bg-indigo-50 p-4 rounded-lg">
            <h3 class="text-sm font-medium text-indigo-700">평균 지각 시간</h3>
            <p class="text-2xl font-bold text-indigo-900" id="avgLateTime">-</p>
          </div>
          <div class="bg-purple-50 p-4 rounded-lg">
            <h3 class="text-sm font-medium text-purple-700">인정결석률</h3>
            <p class="text-2xl font-bold text-purple-900" id="excusedRate">-</p>
          </div>
        </div>
      </section>

      <section class="bg-white rounded-lg shadow mb-6 p-6">
        <h2 class="text-2xl font-bold mb-4">이달의 통계</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div
            class="bg-gradient-to-br from-green-50 to-blue-50 p-4 rounded-lg"
          >
            <h3 class="text-lg font-semibold mb-3">출석왕 TOP 3</h3>
            <div id="attendanceKings" class="space-y-2">
              <!-- 동적으로 추가될 내용 -->
            </div>
          </div>

          <div
            class="bg-gradient-to-br from-purple-50 to-pink-50 p-4 rounded-lg"
          >
            <h3 class="text-lg font-semibold mb-3">개선왕 TOP 3</h3>
            <div id="improvementKings" class="space-y-2">
              <!-- 동적으로 추가될 내용 -->
            </div>
          </div>

          <div
            class="bg-gradient-to-br from-yellow-50 to-red-50 p-4 rounded-lg"
          >
            <h3 class="text-lg font-semibold mb-3">개근상 후보</h3>
            <div id="perfectAttendance" class="space-y-2">
              <!-- 동적으로 추가될 내용 -->
            </div>
          </div>
        </div>
      </section>

      <section class="bg-white rounded-lg shadow">
        <div class="p-6">
          <h2 class="text-2xl font-bold mb-4">상세 통계</h2>
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    학번
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    이름
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    학년-반-번호
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    출석률
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    출석/지각/결석
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    평균 지각시간
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    오늘의 출석
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    상세
                  </th>
                </tr>
              </thead>
              <tbody
                id="statsTableBody"
                class="bg-white divide-y divide-gray-200"
              >
                <!-- 동적으로 추가될 내용 -->
              </tbody>
            </table>
          </div>
        </div>
      </section>
    </main>

    <footer class="bg-white text-gray-600 py-2 sm:py-4 mt-auto">
      <div class="container mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex flex-col items-center text-center">
          <h4 class="text-lg font-semibold mb-2">연락</h4>
          <p class="mb-2">이메일: ksb19558@naver.com</p>
          <a
            href="https://sungblab.vercel.app/blog"
            target="_blank"
            rel="noopener noreferrer"
            class="text-primary hover:underline mb-4"
            >개발자 블로그로 가기</a
          >
        </div>
        <div class="text-center">
          <p>&copy; 2024 디지털 출결관리. All rights reserved.</p>
        </div>
      </div>
    </footer>

    <div
      id="studentDetailModal"
      class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full"
    >
      <div
        class="relative top-20 mx-auto p-5 border w-11/12 max-w-4xl shadow-lg rounded-md bg-white"
      >
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-2xl font-bold" id="modalTitle">학생 상세 통계</h3>
          <button
            onclick="closeModal()"
            class="text-gray-600 hover:text-gray-800"
          >
            <i class="ri-close-line text-2xl"></i>
          </button>
        </div>

        <!-- 학생 기본 정보 -->
        <div class="bg-gray-50 p-4 rounded-lg mb-4">
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div>
              <p class="text-sm text-gray-600">학번</p>
              <p class="font-semibold" id="modalStudentId"></p>
            </div>
            <div>
              <p class="text-sm text-gray-600">이름</p>
              <p class="font-semibold" id="modalStudentName"></p>
            </div>
            <div>
              <p class="text-sm text-gray-600">학년-반</p>
              <p class="font-semibold" id="modalStudentClass"></p>
            </div>
            <div>
              <p class="text-sm text-gray-600">번호</p>
              <p class="font-semibold" id="modalStudentNumber"></p>
            </div>
          </div>
        </div>

        <!-- 월별 통계 그래프 -->
        <div class="mb-6">
          <h4 class="text-lg font-semibold mb-2">월별 통계</h4>
          <div class="bg-white p-4 rounded-lg shadow">
            <canvas id="monthlyStatsChart"></canvas>
          </div>
        </div>

        <!-- 출석 상세 기록 -->
        <div class="mb-6">
          <h4 class="text-lg font-semibold mb-2">출석 기록</h4>
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                  >
                    날짜
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                  >
                    상태
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                  >
                    지각시간
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase"
                  >
                    비고
                  </th>
                </tr>
              </thead>
              <tbody
                id="modalAttendanceList"
                class="bg-white divide-y divide-gray-200"
              >
                <!-- 동적으로 추가될 내용 -->
              </tbody>
            </table>
          </div>
        </div>

        <!-- 개선도 그래프 -->
        <div>
          <h4 class="text-lg font-semibold mb-2">월별 개선도</h4>
          <div class="bg-white p-4 rounded-lg shadow">
            <canvas id="improvementChart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <script>
      axios.defaults.baseURL =
        "https://port-0-attend-backend-m0tl39wtc3a73922.sel4.cloudtype.app";

      document.addEventListener("DOMContentLoaded", function () {
        checkLoginAndRedirect();
        initializeDateRange();
        setupEventListeners();
        fetchAttendanceStats();
      });

      function checkLoginAndRedirect() {
        const token = localStorage.getItem("token");
        if (!token) {
          window.location.href = "/index.html";
        }
      }

      function initializeDateRange() {
        const startDate = document.getElementById("startDate");
        const endDate = document.getElementById("endDate");

        // 이번 달 1일부터 오늘까지를 기본값으로 설정
        const today = moment().format("YYYY-MM-DD");
        const firstDayOfMonth = moment().startOf("month").format("YYYY-MM-DD");

        startDate.value = firstDayOfMonth;
        endDate.value = today;
      }

      function setupEventListeners() {
        // 검색 버튼 클릭 이벤트
        document
          .getElementById("searchBtn")
          .addEventListener("click", fetchAttendanceStats);

        // 학생 검색 입력 이벤트 (디바운스 적용)
        const studentIdInput = document.getElementById("studentIdInput");
        let debounceTimer;
        studentIdInput.addEventListener("input", (e) => {
          clearTimeout(debounceTimer);
          debounceTimer = setTimeout(() => {
            fetchAttendanceStats();
          }, 500);
        });

        // 학년/반 선택 변경 이벤트
        document
          .getElementById("gradeSelect")
          .addEventListener("change", fetchAttendanceStats);
        document
          .getElementById("classSelect")
          .addEventListener("change", fetchAttendanceStats);
      }

      async function fetchAttendanceStats() {
        try {
          const token = localStorage.getItem("token");
          if (!token) {
            window.location.href =
              "index.html?error=" + encodeURIComponent("로그인이 필요합니다.");
            return;
          }

          const response = await axios.get("/api/attendance/stats", {
            params: {
              startDate: document.getElementById("startDate").value,
              endDate: document.getElementById("endDate").value,
              grade: document.getElementById("gradeSelect").value,
              classNum: document.getElementById("classSelect").value,
            },
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });

          if (!response.data.success) {
            throw new Error(
              response.data.message || "통계 조회에 실패했습니다."
            );
          }

          const { studentStats, overallStats, specialStats } = response.data;
          updateOverallStats(overallStats);
          updateStudentStats(studentStats);
          updateSpecialStats(specialStats);
        } catch (error) {
          console.error("통계 조회 중 오류 발:", error);
          alert(error.message || "통계 조회 중 오류가 발생했습니다.");
        }
      }

      function updateOverallStats(stats) {
        document.getElementById(
          "totalStudents"
        ).textContent = `${stats.totalStudents}명`;
        document.getElementById(
          "attendanceRate"
        ).textContent = `${stats.averageAttendanceRate}%`;
        document.getElementById("lateRate").textContent = `${(
          (stats.totalLate /
            (stats.totalPresent + stats.totalLate + stats.totalAbsent)) *
          100
        ).toFixed(1)}%`;
        document.getElementById("absentRate").textContent = `${(
          (stats.totalAbsent /
            (stats.totalPresent + stats.totalLate + stats.totalAbsent)) *
          100
        ).toFixed(1)}%`;
        document.getElementById(
          "avgLateTime"
        ).textContent = `${(stats.totalLate > 0
          ? stats.totalLateMinutes / stats.totalLate
          : 0
        ).toFixed(1)}분`;
        document.getElementById("excusedRate").textContent = `${(
          (stats.totalExcused /
            (stats.totalPresent + stats.totalLate + stats.totalAbsent)) *
          100
        ).toFixed(1)}%`;
      }

      function updateStudentStats(stats) {
        if (!stats || !Array.isArray(stats)) {
          console.error("Invalid stats data:", stats);
          return;
        }

        const tbody = document.getElementById("statsTableBody");
        tbody.innerHTML = stats
          .map((student) => {
            if (!student) return "";

            const { summary } = student;
            return `
              <tr class="hover:bg-gray-50 transition-colors">
                <td class="px-6 py-4 whitespace-nowrap">${
                  student.studentId
                }</td>
                <td class="px-6 py-4 whitespace-nowrap">${student.name}</td>
                <td class="px-6 py-4 whitespace-nowrap">${student.grade}-${
              student.class
            }-${student.number}</td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="flex items-center">
                    <div class="w-16 bg-gray-200 rounded-full h-2 mr-2">
                      <div class="bg-green-500 rounded-full h-2" style="width: ${
                        summary.attendanceRate
                      }%"></div>
                    </div>
                    <span>${summary.attendanceRate}%</span>
                  </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <span class="text-green-600">${summary.presentCount}</span>
                  <span class="text-gray-400">/</span>
                  <span class="text-yellow-600">${summary.lateCount}</span>
                  <span class="text-gray-400">/</span>
                  <span class="text-red-600">${summary.absentCount}</span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  ${
                    summary.lateCount > 0
                      ? `${(
                          summary.totalLateMinutes / summary.lateCount
                        ).toFixed(1)}분`
                      : "-"
                  }
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  ${
                    student.todayStatus
                      ? `<span class="${getStatusBadgeClass(
                          student.todayStatus.status
                        )}">
                      ${getStatusText(student.todayStatus.status)}
                      ${
                        student.todayStatus.lateMinutes
                          ? `(${student.todayStatus.lateMinutes}분)`
                          : ""
                      }
                    </span>`
                      : '<span class="text-gray-400">미출석</span>'
                  }
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <button 
                    onclick="showStudentDetail('${student.studentId}')"
                    class="text-primary hover:text-secondary transition-colors"
                  >
                    <i class="ri-file-list-line mr-1"></i>상세보기
                  </button>
                </td>
              </tr>
            `;
          })
          .join("");
      }

      function getStatusColor(status) {
        switch (status) {
          case "present":
            return "text-green-600";
          case "late":
            return "text-yellow-600";
          case "absent":
            return "text-red-600";
          case "excused":
            return "text-blue-600";
          default:
            return "text-gray-600";
        }
      }

      function updateSpecialStats(specialStats) {
        const attendanceKingDiv = document.getElementById("attendanceKing");
        if (specialStats.monthlyAttendanceKing) {
          const king = specialStats.monthlyAttendanceKing;
          attendanceKingDiv.innerHTML = `
            <p>학번: ${king._id}</p>
            <p>출석 횟수: ${king.presentCount}회</p>
          `;
        }

        const lateKingDiv = document.getElementById("lateKing");
        if (specialStats.lateKing) {
          const king = specialStats.lateKing;
          lateKingDiv.innerHTML = `
            <p>학번: ${king._id}</p>
            <p>지각 횟수: ${king.lateCount}회</p>
            <p>총 지각 시간: ${king.totalLateMinutes}분</p>
          `;
        }

        updateAbsenceLists(specialStats.excusedAbsences, specialStats.absences);
      }

      function updateAbsenceLists(excused, normal) {
        const excusedList = document.getElementById("excusedAbsencesList");
        const normalList = document.getElementById("absencesList");

        excusedList.innerHTML = excused
          .map(
            (absence) => `
          <div class="mb-2 p-2 bg-white rounded shadow">
            <p>학번: ${absence.studentId}</p>
            <p>날짜: ${moment(absence.timestamp).format("YYYY-MM-DD")}</p>
            <p>사유: ${absence.reason || "사유 없음"}</p>
          </div>
        `
          )
          .join("");

        normalList.innerHTML = normal
          .map(
            (absence) => `
          <div class="mb-2 p-2 bg-white rounded shadow">
            <p>학번: ${absence.studentId}</p>
            <p>날짜: ${moment(absence.timestamp).format("YYYY-MM-DD")}</p>
            <button 
              onclick="handleExcuseAbsence('${absence.studentId}', '${
              absence.timestamp
            }')"
              class="mt-2 text-blue-600 hover:text-blue-800"
            >
              인정결석으로 변경
            </button>
          </div>
        `
          )
          .join("");
      }

      document
        .getElementById("excuseForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const studentId = document.getElementById("excuseStudentId").value;
          const date = document.getElementById("excuseDate").value;
          const reason = document.getElementById("excuseReason").value;

          if (!studentId || !date || !reason) {
            alert("모든 필드를 입력해주세요.");
            return;
          }

          try {
            const response = await axios.post(
              "/api/attendance/excuse",
              {
                studentId,
                date,
                reason,
              },
              {
                headers: {
                  Authorization: `Bearer ${localStorage.getItem("token")}`,
                },
              }
            );

            alert("인정결석 처리가 완료되었습니다.");
            document.getElementById("excuseForm").reset();
            fetchAttendanceStats(); // 통계 새로고침
          } catch (error) {
            console.error("인정결석 처리 중 오류:", error);
            alert(
              error.response?.data?.message ||
                "인정결석 처리 중 오류가 발생했습니다."
            );
          }
        });

      async function handleExcuseAbsence(studentId, date) {
        const reason = prompt("인정결석 사유를 입력해주세요:");
        if (!reason) return;

        try {
          const token = localStorage.getItem("token");
          if (!token) {
            throw new Error("로그인이 필요합니다.");
          }

          const response = await axios.post(
            "/api/attendance/excuse",
            {
              studentId,
              date: moment(date).format("YYYY-MM-DD"),
              reason,
            },
            {
              headers: {
                Authorization: `Bearer ${token}`,
              },
            }
          );

          if (!response.data.success) {
            throw new Error(
              response.data.message || "인정결석 처리에 실패했습니다."
            );
          }

          alert(response.data.message);
          await fetchAttendanceStats(); // 통계 새로고침
        } catch (error) {
          console.error("인정결석 처리 중 오류:", error);
          alert(
            error.response?.data?.message ||
              error.message ||
              "인정결석 처리 중 오류가 발생했습니다."
          );
        }
      }

      axios.interceptors.response.use(
        (response) => response,
        async (error) => {
          const originalRequest = error.config;

          if (error.response.status === 401 && !originalRequest._retry) {
            originalRequest._retry = true;

            try {
              const refreshToken = localStorage.getItem("refreshToken");
              if (!refreshToken) {
                throw new Error("리프레시 토큰이 없습니다.");
              }

              const response = await axios.post("/api/refresh-token", {
                refreshToken,
              });

              const { accessToken, refreshToken: newRefreshToken } =
                response.data;

              localStorage.setItem("token", accessToken);
              localStorage.setItem("refreshToken", newRefreshToken);

              originalRequest.headers[
                "Authorization"
              ] = `Bearer ${accessToken}`;
              return axios(originalRequest);
            } catch (error) {
              console.error("토큰 갱신 실패:", error);
              localStorage.clear();
              window.location.href =
                "/index.html?error=" +
                encodeURIComponent(
                  "세션이 만료되었습니다. 다시 로그인해주세요."
                );
              return Promise.reject(error);
            }
          }

          return Promise.reject(error);
        }
      );

      document.addEventListener("DOMContentLoaded", () => {
        const today = moment().format("YYYY-MM-DD");
        const firstDayOfMonth = moment().startOf("month").format("YYYY-MM-DD");

        document.getElementById("startDate").value = firstDayOfMonth;
        document.getElementById("endDate").value = today;

        fetchAttendanceStats();
      });

      function updateMonthlyStats(rankings) {
        // 출석왕 TOP 3
        const attendanceKings = document.getElementById("attendanceKings");
        attendanceKings.innerHTML = rankings.attendance
          .map(
            (student, index) => `
            <div class="flex items-center justify-between p-2 ${
              index === 0 ? "bg-green-100" : "bg-green-50"
            } rounded-lg">
              <div class="flex items-center">
                <span class="text-lg font-bold mr-2">${index + 1}</span>
                <div>
                  <p class="font-semibold">${student.grade}-${student.class} ${
              student.name
            }</p>
                  <p class="text-sm text-gray-600">${student.studentId}</p>
                </div>
              </div>
              <div class="text-right">
                <p class="font-bold text-green-700">${student.count}회</p>
              </div>
            </div>
          `
          )
          .join("");

        // 개선왕 TOP 3
        const improvementKings = document.getElementById("improvementKings");
        improvementKings.innerHTML = rankings.improvement
          .map(
            (student, index) => `
            <div class="flex items-center justify-between p-2 ${
              index === 0 ? "bg-purple-100" : "bg-purple-50"
            } rounded-lg">
              <div class="flex items-center">
                <span class="text-lg font-bold mr-2">${index + 1}</span>
                <div>
                  <p class="font-semibold">${student.grade}-${student.class} ${
              student.name
            }</p>
                  <p class="text-sm text-gray-600">${student.studentId}</p>
                </div>
              </div>
              <div class="text-right">
                <p class="font-bold text-purple-700">+${
                  student.improvement
                }%</p>
              </div>
            </div>
          `
          )
          .join("");

        // 개근상 후보
        const perfectAttendance = document.getElementById("perfectAttendance");
        perfectAttendance.innerHTML =
          rankings.attendance
            .filter((student) => student.count === moment().daysInMonth())
            .map(
              (student) => `
            <div class="flex items-center justify-between p-2 bg-yellow-50 rounded-lg">
              <div>
                <p class="font-semibold">${student.grade}-${student.class} ${student.name}</p>
                <p class="text-sm text-gray-600">${student.studentId}</p>
              </div>
              <div class="text-right">
                <p class="font-bold text-yellow-700">100%</p>
              </div>
            </div>
          `
            )
            .join("") || "<p class='text-center text-gray-500'>해당자 없음</p>";
      }

      function showStudentDetail(studentId) {
        // 모달 표시
        const modal = document.getElementById("studentDetailModal");
        modal.classList.remove("hidden");

        // 상세 데이터 로드
        fetchStudentDetail(studentId);
      }

      async function fetchStudentDetail(studentId) {
        try {
          const response = await axios.get(
            `/api/attendance/student/${studentId}`,
            {
              headers: {
                Authorization: `Bearer ${localStorage.getItem("token")}`,
              },
            }
          );

          if (!response.data.success) {
            throw new Error(response.data.message);
          }

          updateStudentDetailModal(response.data);
        } catch (error) {
          console.error("학생 상세 통계 조회 중 오류:", error);
          alert(error.message || "상세 통계 조회에 실패했습니다.");
        }
      }

      // 모달 관련 함수들 추가
      function updateStudentDetailModal(data) {
        const { student, totalStats, monthlyStats, improvements, attendances } =
          data;

        // 학생 기본 정보 업데이트
        document.getElementById(
          "modalTitle"
        ).textContent = `${student.name} 학생 상세 통계`;
        document.getElementById("modalStudentId").textContent =
          student.studentId;
        document.getElementById("modalStudentName").textContent = student.name;
        document.getElementById(
          "modalStudentClass"
        ).textContent = `${student.grade}-${student.class}`;
        document.getElementById("modalStudentNumber").textContent =
          student.number;

        // 월별 통계 차트 업데이트
        updateMonthlyStatsChart(monthlyStats);

        // 출석 기록 테이블 업데이트
        const attendanceList = document.getElementById("modalAttendanceList");
        attendanceList.innerHTML = attendances
          .map(
            (attendance) => `
            <tr>
              <td class="px-6 py-4 whitespace-nowrap">${attendance.date}</td>
              <td class="px-6 py-4 whitespace-nowrap">
                <span class="${getStatusColor(attendance.status)}">
                  ${getStatusText(attendance.status)}
                </span>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                ${attendance.lateMinutes ? `${attendance.lateMinutes}분` : "-"}
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                ${
                  attendance.isExcused
                    ? `<span class="text-blue-600">인정결석</span><br><span class="text-sm text-gray-500">${
                        attendance.reason || ""
                      }</span>`
                    : ""
                }
              </td>
            </tr>
          `
          )
          .join("");

        // 개선도 차트 업데이트
        updateImprovementChart(improvements);
      }

      // 월별 통계 차트 생성/업데이트
      function updateMonthlyStatsChart(monthlyStats) {
        const ctx = document
          .getElementById("monthlyStatsChart")
          .getContext("2d");
        const months = Object.keys(monthlyStats);

        // 기존 차트가 있다면 제거
        if (window.monthlyChart) {
          window.monthlyChart.destroy();
        }

        window.monthlyChart = new Chart(ctx, {
          type: "bar",
          data: {
            labels: months,
            datasets: [
              {
                label: "출석",
                data: months.map((month) => monthlyStats[month].present),
                backgroundColor: "rgba(34, 197, 94, 0.5)",
                borderColor: "rgb(34, 197, 94)",
                borderWidth: 1,
              },
              {
                label: "지각",
                data: months.map((month) => monthlyStats[month].late),
                backgroundColor: "rgba(234, 179, 8, 0.5)",
                borderColor: "rgb(234, 179, 8)",
                borderWidth: 1,
              },
              {
                label: "결석",
                data: months.map((month) => monthlyStats[month].absent),
                backgroundColor: "rgba(239, 68, 68, 0.5)",
                borderColor: "rgb(239, 68, 68)",
                borderWidth: 1,
              },
              {
                label: "인정결석",
                data: months.map((month) => monthlyStats[month].excused),
                backgroundColor: "rgba(59, 130, 246, 0.5)",
                borderColor: "rgb(59, 130, 246)",
                borderWidth: 1,
              },
            ],
          },
          options: {
            responsive: true,
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  stepSize: 1,
                },
              },
            },
            plugins: {
              title: {
                display: true,
                text: "월별 출석 현황",
              },
            },
          },
        });
      }

      // 개선도 차트 생성/업데이트
      function updateImprovementChart(improvements) {
        const ctx = document
          .getElementById("improvementChart")
          .getContext("2d");

        // 기존 차트가 있다면 제거
        if (window.improvementChart) {
          window.improvementChart.destroy();
        }

        window.improvementChart = new Chart(ctx, {
          type: "line",
          data: {
            labels: improvements.map((imp) => imp.month),
            datasets: [
              {
                label: "개선도",
                data: improvements.map((imp) => imp.improvement),
                borderColor: "rgb(147, 51, 234)",
                backgroundColor: "rgba(147, 51, 234, 0.1)",
                tension: 0.3,
                fill: true,
              },
            ],
          },
          options: {
            responsive: true,
            scales: {
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: "개선도 (%)",
                },
              },
            },
            plugins: {
              title: {
                display: true,
                text: "월별 출석 개선도",
              },
            },
          },
        });
      }

      // 상태 텍스트 변환 함수
      function getStatusText(status) {
        switch (status) {
          case "present":
            return "출석";
          case "late":
            return "지각";
          case "absent":
            return "결석";
          default:
            return "미출석";
        }
      }

      // 모달 닫기 함수
      function closeModal() {
        document.getElementById("studentDetailModal").classList.add("hidden");
      }

      // 차트.js 라이브러리 추가
      const script = document.createElement("script");
      script.src = "https://cdn.jsdelivr.net/npm/chart.js";
      document.head.appendChild(script);

      // 상태별 배지 스타일 클래스
      function getStatusBadgeClass(status) {
        const baseClasses = "px-2 py-1 rounded-full text-xs font-medium";
        switch (status) {
          case "present":
            return `${baseClasses} bg-green-100 text-green-800`;
          case "late":
            return `${baseClasses} bg-yellow-100 text-yellow-800`;
          case "absent":
            return `${baseClasses} bg-red-100 text-red-800`;
          default:
            return `${baseClasses} bg-gray-100 text-gray-800`;
        }
      }

      // Chart.js 설정 추가
      Chart.defaults.font.family = "'Inter', sans-serif";
      Chart.defaults.color = "#374151";
      Chart.defaults.plugins.tooltip.backgroundColor = "rgba(17, 24, 39, 0.8)";
      Chart.defaults.plugins.tooltip.padding = 12;
      Chart.defaults.plugins.tooltip.cornerRadius = 8;
      Chart.defaults.plugins.tooltip.titleFont = {
        size: 14,
        weight: "bold",
      };
      Chart.defaults.plugins.tooltip.bodyFont = {
        size: 13,
      };

      // 차트 업데이트 시 애니메이션 설정
      const chartAnimationOptions = {
        animation: {
          duration: 750,
          easing: "easeOutQuart",
        },
        transitions: {
          active: {
            animation: {
              duration: 200,
            },
          },
        },
      };

      // 차트 색상 테마
      const chartColors = {
        present: {
          background: "rgba(34, 197, 94, 0.5)",
          border: "rgb(34, 197, 94)",
        },
        late: {
          background: "rgba(234, 179, 8, 0.5)",
          border: "rgb(234, 179, 8)",
        },
        absent: {
          background: "rgba(239, 68, 68, 0.5)",
          border: "rgb(239, 68, 68)",
        },
        excused: {
          background: "rgba(59, 130, 246, 0.5)",
          border: "rgb(59, 130, 246)",
        },
        improvement: {
          background: "rgba(147, 51, 234, 0.1)",
          border: "rgb(147, 51, 234)",
        },
      };

      // Chart.js 설정
      const chartConfig = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: "bottom",
            labels: {
              usePointStyle: true,
              padding: 20,
            },
          },
          tooltip: {
            mode: "index",
            intersect: false,
            padding: 10,
            titleFont: {
              size: 14,
              weight: "bold",
            },
            bodyFont: {
              size: 13,
            },
          },
        },
        scales: {
          y: {
            beginAtZero: true,
            grid: {
              drawBorder: false,
            },
          },
          x: {
            grid: {
              display: false,
            },
          },
        },
      };
    </script>
  </body>
</html>
