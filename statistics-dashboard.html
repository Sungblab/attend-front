<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>디지털 출결관리</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment-timezone/0.5.33/moment-timezone-with-data.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: "#4F46E5",
              secondary: "#3730A3",
              accent: "#EEF2FF",
            },
            fontFamily: {
              sans: ["Inter", "sans-serif"],
            },
          },
        },
      };
    </script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css"
      rel="stylesheet"
    />
  </head>
  <body class="bg-gray-50">
    <header>
      <nav
        class="container mx-auto px-4 sm:px-6 lg:px-8 py-2 sm:py-4 flex justify-between items-center"
      >
        <a
          href="/hub.html"
          class="text-xl sm:text-2xl font-bold text-primary flex items-center"
        >
          <i class="ri-calendar-check-fill mr-2"></i>
          디지털 출결관리
        </a>
      </nav>
    </header>

    <main class="container mx-auto px-4 py-8">
      <section class="bg-white rounded-lg shadow mb-6 p-6">
        <h2 class="text-2xl font-bold mb-4">필터</h2>
        <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1"
              >시작일</label
            >
            <input
              type="date"
              id="startDate"
              class="w-full rounded-lg border-gray-300"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1"
              >종료일</label
            >
            <input
              type="date"
              id="endDate"
              class="w-full rounded-lg border-gray-300"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1"
              >학년</label
            >
            <select id="gradeSelect" class="w-full rounded-lg border-gray-300">
              <option value="">전체</option>
              <option value="1">1학년</option>
              <option value="2">2학년</option>
              <option value="3">3학년</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1"
              >반</label
            >
            <select id="classSelect" class="w-full rounded-lg border-gray-300">
              <option value="">전체</option>
              <option value="1">1반</option>
              <option value="2">2반</option>
              <option value="3">3반</option>
              <option value="4">4반</option>
              <option value="5">5반</option>
              <option value="6">6반</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1"
              >학번</label
            >
            <input
              type="text"
              id="studentIdInput"
              placeholder="학번 검색"
              class="w-full rounded-lg border-gray-300"
            />
          </div>
        </div>
        <div class="mt-4 flex justify-end">
          <button
            id="searchBtn"
            class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-secondary transition-colors"
          >
            <i class="ri-search-line mr-2"></i>검색
          </button>
        </div>
      </section>

      <section class="bg-white rounded-lg shadow mb-6 p-6">
        <h2 class="text-2xl font-bold mb-6 flex items-center">
          <i class="ri-bar-chart-box-line mr-2"></i>
          전체 통계
        </h2>
        <div
          class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-6"
        >
          <!-- 전체 학생 카드 -->
          <div
            class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-xl p-4 border border-blue-100"
          >
            <div class="flex items-center justify-between mb-3">
              <span class="text-blue-600 bg-blue-100 p-2 rounded-lg">
                <i class="ri-user-line text-xl"></i>
              </span>
              <span
                class="text-xs font-medium text-blue-600 bg-blue-100 px-2 py-1 rounded-full"
                >전체</span
              >
            </div>
            <h3 class="text-sm font-medium text-gray-600 mb-1">전체 학생</h3>
            <p class="text-2xl font-bold text-gray-900" id="totalStudents">-</p>
          </div>

          <!-- 출석률 카드 -->
          <div
            class="bg-gradient-to-br from-green-50 to-emerald-50 rounded-xl p-4 border border-green-100"
          >
            <div class="flex items-center justify-between mb-3">
              <span class="text-green-600 bg-green-100 p-2 rounded-lg">
                <i class="ri-check-line text-xl"></i>
              </span>
              <span
                class="text-xs font-medium text-green-600 bg-green-100 px-2 py-1 rounded-full"
                >출석</span
              >
            </div>
            <h3 class="text-sm font-medium text-gray-600 mb-1">출석률</h3>
            <p class="text-2xl font-bold text-gray-900" id="attendanceRate">
              -
            </p>
          </div>

          <!-- 지각률 카드 -->
          <div
            class="bg-gradient-to-br from-yellow-50 to-amber-50 rounded-xl p-4 border border-yellow-100"
          >
            <div class="flex items-center justify-between mb-3">
              <span class="text-yellow-600 bg-yellow-100 p-2 rounded-lg">
                <i class="ri-time-line text-xl"></i>
              </span>
              <span
                class="text-xs font-medium text-yellow-600 bg-yellow-100 px-2 py-1 rounded-full"
                >지각</span
              >
            </div>
            <h3 class="text-sm font-medium text-gray-600 mb-1">지각률</h3>
            <div class="flex items-baseline gap-2">
              <p class="text-2xl font-bold text-gray-900" id="lateRate">-</p>
              <p class="text-sm text-gray-500" id="avgLateTime">평균 -분</p>
            </div>
          </div>

          <!-- 결석률 카드 -->
          <div
            class="bg-gradient-to-br from-red-50 to-rose-50 rounded-xl p-4 border border-red-100"
          >
            <div class="flex items-center justify-between mb-3">
              <span class="text-red-600 bg-red-100 p-2 rounded-lg">
                <i class="ri-close-circle-line text-xl"></i>
              </span>
              <span
                class="text-xs font-medium text-red-600 bg-red-100 px-2 py-1 rounded-full"
                >결석</span
              >
            </div>
            <h3 class="text-sm font-medium text-gray-600 mb-1">결석률</h3>
            <p class="text-2xl font-bold text-gray-900" id="absentRate">-</p>
          </div>

          <!-- 인정출결률 카드 -->
          <div
            class="bg-gradient-to-br from-purple-50 to-fuchsia-50 rounded-xl p-4 border border-purple-100"
          >
            <div class="flex items-center justify-between mb-3">
              <span class="text-purple-600 bg-purple-100 p-2 rounded-lg">
                <i class="ri-calendar-check-line text-xl"></i>
              </span>
              <span
                class="text-xs font-medium text-purple-600 bg-purple-100 px-2 py-1 rounded-full"
                >인정</span
              >
            </div>
            <h3 class="text-sm font-medium text-gray-600 mb-1">인정출결률</h3>
            <p class="text-2xl font-bold text-gray-900" id="excusedRate">-</p>
          </div>

          <!-- 전체 출석일수 카드 -->
          <div
            class="bg-gradient-to-br from-gray-50 to-slate-50 rounded-xl p-4 border border-gray-100"
          >
            <div class="flex items-center justify-between mb-3">
              <span class="text-gray-600 bg-gray-100 p-2 rounded-lg">
                <i class="ri-calendar-line text-xl"></i>
              </span>
              <span
                class="text-xs font-medium text-gray-600 bg-gray-100 px-2 py-1 rounded-full"
                >기간</span
              >
            </div>
            <h3 class="text-sm font-medium text-gray-600 mb-1">
              전체 출석일수
            </h3>
            <p class="text-2xl font-bold text-gray-900" id="totalDays">-</p>
          </div>
        </div>
      </section>

      <section class="bg-white rounded-lg shadow mb-6 p-6">
        <h2 class="text-2xl font-bold mb-4">이달의 통계</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div
            class="bg-gradient-to-br from-green-50 to-blue-50 p-4 rounded-lg"
          >
            <h3 class="text-lg font-semibold mb-3">출석왕 TOP 3</h3>
            <div id="attendanceKings" class="space-y-2">
              <!-- 동적으로 추가될 내용 -->
            </div>
          </div>

          <div
            class="bg-gradient-to-br from-purple-50 to-pink-50 p-4 rounded-lg"
          >
            <h3 class="text-lg font-semibold mb-3">개선왕 TOP 3</h3>
            <div id="improvementKings" class="space-y-2">
              <!-- 동적으로 추가될 내용 -->
            </div>
          </div>

          <div
            class="bg-gradient-to-br from-yellow-50 to-red-50 p-4 rounded-lg"
          >
            <h3 class="text-lg font-semibold mb-3">지각왕 TOP 3</h3>
            <div id="lateKings" class="space-y-2">
              <!-- 동적으로 추가될 내용 -->
            </div>
          </div>
        </div>
      </section>

      <section class="bg-white rounded-lg shadow">
        <div class="p-6">
          <h2 class="text-2xl font-bold mb-6 flex items-center">
            <i class="ri-file-list-line mr-2"></i>
            상세 통계
          </h2>

          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead>
                <tr class="bg-gray-50">
                  <th
                    class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap"
                  >
                    <div class="flex items-center">
                      <i class="ri-user-line mr-2"></i>
                      학번
                    </div>
                  </th>
                  <th
                    class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap"
                  >
                    <div class="flex items-center">
                      <i class="ri-profile-line mr-2"></i>
                      이름
                    </div>
                  </th>
                  <th
                    class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap"
                  >
                    <div class="flex items-center">
                      <i class="ri-building-line mr-2"></i>
                      학년-반-번호
                    </div>
                  </th>
                  <th
                    class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap"
                  >
                    <div class="flex items-center">
                      <i class="ri-bar-chart-line mr-2"></i>
                      출석률
                    </div>
                  </th>
                  <th
                    class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap"
                  >
                    <div class="flex items-center">
                      <i class="ri-calendar-check-line mr-2"></i>
                      출석/지각/결석
                    </div>
                  </th>
                  <th
                    class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap"
                  >
                    <div class="flex items-center">
                      <i class="ri-time-line mr-2"></i>
                      평균 지각시간
                    </div>
                  </th>
                  <th
                    class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap"
                  >
                    <div class="flex items-center">
                      <i class="ri-calendar-todo-line mr-2"></i>
                      오늘의 출석
                    </div>
                  </th>
                  <th
                    class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap"
                  >
                    <div class="flex items-center">
                      <i class="ri-file-search-line mr-2"></i>
                      상세
                    </div>
                  </th>
                </tr>
              </thead>
              <tbody
                id="statsTableBody"
                class="bg-white divide-y divide-gray-200"
              >
                <!-- 동적으로 추가될 내용 -->
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- 인정출결 관리 섹션 수정 -->
      <section class="bg-white rounded-lg shadow mb-6 p-6 mt-6">
        <h2 class="text-2xl font-bold mb-4">인정출결 관리</h2>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <!-- 개별 인정출결 등록 폼 -->
          <div class="bg-gray-50 p-4 rounded-lg">
            <h3 class="text-lg font-semibold mb-3">개별 인정출결 등록</h3>
            <form id="excuseForm" class="space-y-4">
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1"
                    >학번</label
                  >
                  <input
                    type="text"
                    id="excuseStudentId"
                    class="w-full rounded-lg border-gray-300"
                    required
                  />
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1"
                    >날짜</label
                  >
                  <input
                    type="date"
                    id="excuseDate"
                    class="w-full rounded-lg border-gray-300"
                    required
                  />
                </div>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1"
                  >사유</label
                >
                <textarea
                  id="excuseReason"
                  class="w-full rounded-lg border-gray-300 resize-none"
                  rows="3"
                  required
                ></textarea>
              </div>
              <button
                type="submit"
                class="w-full bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors"
              >
                인정출결 처리
              </button>
            </form>
          </div>

          <!-- 단체 인정출결 등록 폼 추가 -->
          <div class="bg-gray-50 p-4 rounded-lg">
            <h3 class="text-lg font-semibold mb-3">단체 인정출결 등록</h3>
            <form id="groupExcuseForm" class="space-y-4">
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1"
                    >날짜</label
                  >
                  <input
                    type="date"
                    id="groupExcuseDate"
                    class="w-full rounded-lg border-gray-300"
                    required
                  />
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1"
                    >학년</label
                  >
                  <select
                    id="groupExcuseGrade"
                    class="w-full rounded-lg border-gray-300"
                  >
                    <option value="">전체</option>
                    <option value="1">1학년</option>
                    <option value="2">2학년</option>
                    <option value="3">3학년</option>
                  </select>
                </div>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1"
                  >반</label
                >
                <select
                  id="groupExcuseClass"
                  class="w-full rounded-lg border-gray-300"
                >
                  <option value="">전체</option>
                  <option value="1">1반</option>
                  <option value="2">2반</option>
                  <option value="3">3반</option>
                  <option value="4">4반</option>
                  <option value="5">5반</option>
                  <option value="6">6반</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1"
                  >사유</label
                >
                <textarea
                  id="groupExcuseReason"
                  class="w-full rounded-lg border-gray-300 resize-none"
                  rows="3"
                  required
                ></textarea>
              </div>
              <button
                type="submit"
                class="w-full bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors"
              >
                단체 인정출결 처리
              </button>
            </form>
          </div>

          <!-- 최근 인정출결 목록 -->
          <div class="bg-gray-50 p-4 rounded-lg lg:col-span-2">
            <h3 class="text-lg font-semibold mb-3">최근 인정출결 목록</h3>
            <div
              id="excusedList"
              class="space-y-2 max-h-[400px] overflow-y-auto"
            >
              <!-- 동적으로 추가될 내용 -->
            </div>
          </div>
        </div>
      </section>

      <!-- 휴일 관리 섹션을 여기로 이동 -->
      <section class="bg-white rounded-lg shadow mb-6 p-6">
        <h2 class="text-2xl font-bold mb-4">휴일 관리</h2>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <!-- 휴일 등록 폼... -->
          <div class="bg-gray-50 p-4 rounded-lg">
            <h3 class="text-lg font-semibold mb-3">휴일 등록</h3>
            <form id="holidayForm" class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1"
                  >날짜</label
                >
                <input
                  type="date"
                  id="holidayDate"
                  class="w-full rounded-lg border-gray-300"
                  required
                />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1"
                  >사유</label
                >
                <input
                  type="text"
                  id="holidayReason"
                  class="w-full rounded-lg border-gray-300"
                  placeholder="예: 개교기념일, 현충일 등"
                  required
                />
              </div>
              <button
                type="submit"
                class="w-full bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors"
              >
                휴일 등록
              </button>
            </form>
          </div>

          <!-- 휴일 목록... -->
          <div class="bg-gray-50 p-4 rounded-lg">
            <h3 class="text-lg font-semibold mb-3">등록된 휴일 목록</h3>
            <div
              id="holidayList"
              class="space-y-2 max-h-[400px] overflow-y-auto"
            >
              <!-- 동적으로 추가될 내용 -->
            </div>
          </div>
        </div>
      </section>
    </main>

    <footer class="bg-white text-gray-600 py-2 sm:py-4 mt-auto">
      <div class="container mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex flex-col items-center text-center">
          <h4 class="text-lg font-semibold mb-2">연락</h4>
          <p class="mb-2">이메일: ksb19558@naver.com</p>
          <a
            href="https://sungblab.vercel.app/blog"
            target="_blank"
            rel="noopener noreferrer"
            class="text-primary hover:underline mb-4"
            >개발자 블로그로 가기</a
          >
        </div>
        <div class="text-center">
          <p>&copy; 2024 디지털 출결관리. All rights reserved.</p>
        </div>
      </div>
    </footer>

    <div
      id="studentDetailModal"
      class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50"
    >
      <div
        class="relative mx-auto my-8 p-6 border w-11/12 max-w-6xl shadow-lg rounded-lg bg-white"
      >
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-2xl font-bold" id="modalTitle">학생 상세 통계</h3>
          <button
            onclick="closeModal()"
            class="text-gray-600 hover:text-gray-800"
          >
            <i class="ri-close-line text-2xl"></i>
          </button>
        </div>

        <!-- 학생 기본 정보 -->
        <div class="bg-gray-50 p-4 rounded-lg mb-4">
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div>
              <p class="text-sm text-gray-600">학번</p>
              <p class="font-semibold" id="modalStudentId"></p>
            </div>
            <div>
              <p class="text-sm text-gray-600">이름</p>
              <p class="font-semibold" id="modalStudentName"></p>
            </div>
            <div>
              <p class="text-sm text-gray-600">학년-반</p>
              <p class="font-semibold" id="modalStudentClass"></p>
            </div>
            <div>
              <p class="text-sm text-gray-600">번</p>
              <p class="font-semibold" id="modalStudentNumber"></p>
            </div>
          </div>
        </div>

        <!-- 오늘의 출석 상태 -->
        <div class="bg-gray-50 p-4 rounded-lg mb-4">
          <div id="modalTodayStatus">
            <!-- 오늘의 출석 상태가 여기에 동적으로 추가됨 -->
          </div>
        </div>

        <!-- 전체 통계 요약 -->
        <div class="mb-8">
          <h4 class="text-lg font-semibold mb-4">전체 통계 요약</h4>
          <div id="modalSummary">
            <!-- 동적으로 추가될 내용 -->
          </div>
        </div>

        <!-- 차트 컨테이너 수수정 -->
        <div class="grid grid-cols-1 gap-6 mb-8">
          <!-- 월별 통계 그래프만 남기고 개선도 차트 제거 -->
          <div>
            <h4 class="text-lg font-semibold mb-4">월별 통계</h4>
            <div class="bg-white p-4 rounded-lg shadow" style="height: 300px">
              <canvas id="monthlyStatsChart"></canvas>
            </div>
          </div>
        </div>

        <!-- 출석 기록 테이블 수정 -->
        <div class="mb-8">
          <h4 class="text-lg font-semibold mb-4">출석 기록</h4>
          <div class="overflow-x-auto rounded-lg shadow">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th
                    class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase w-1/5"
                  >
                    날짜
                  </th>
                  <th
                    class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase w-1/5"
                  >
                    상태
                  </th>
                  <th
                    class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase w-1/5"
                  >
                    지각시간
                  </th>
                </tr>
              </thead>
              <tbody
                id="modalAttendanceList"
                class="bg-white divide-y divide-gray-200"
              >
                <!-- 동적으로 추가될 내용 -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <script>
      axios.defaults.baseURL =
        "https://port-0-attend-backend-m0tl39wtc3a73922.sel4.cloudtype.app";

      document.addEventListener("DOMContentLoaded", async function () {
        try {
          await loadChartJS();
          checkLoginAndRedirect();
          initializeDateRange();
          setupEventListeners();
          await Promise.all([fetchAttendanceStats(), updateExcusedList()]);
        } catch (error) {
          console.error("초기화 중 오류:", error);
          alert("페이지 초기화 중 오류가 발생했습니다.");
        }
      });

      async function loadChartJS() {
        if (typeof Chart !== "undefined") return;

        return new Promise((resolve, reject) => {
          const script = document.createElement("script");
          script.src = "https://cdn.jsdelivr.net/npm/chart.js";
          script.onload = resolve;
          script.onerror = reject;
          document.head.appendChild(script);
        });
      }

      function checkLoginAndRedirect() {
        const token = localStorage.getItem("token");
        if (!token) {
          window.location.href = "/index.html";
        }
      }

      function initializeDateRange() {
        const startDate = document.getElementById("startDate");
        const endDate = document.getElementById("endDate");

        // 이번 달 1일부터 오늘지를 기본값으로 설정
        const today = moment().format("YYYY-MM-DD");
        const firstDayOfMonth = moment().startOf("month").format("YYYY-MM-DD");

        startDate.value = firstDayOfMonth;
        endDate.value = today;
      }

      function setupEventListeners() {
        // 검 버튼 클 이벤트
        document
          .getElementById("searchBtn")
          .addEventListener("click", fetchAttendanceStats);

        // 학생 검색 입력 이벤트 (디바운스 적용)
        const studentIdInput = document.getElementById("studentIdInput");
        let debounceTimer;
        studentIdInput.addEventListener("input", (e) => {
          clearTimeout(debounceTimer);
          debounceTimer = setTimeout(() => {
            fetchAttendanceStats();
          }, 500);
        });

        // 학년/반 선택 변경 이벤트
        document
          .getElementById("gradeSelect")
          .addEventListener("change", fetchAttendanceStats);
        document
          .getElementById("classSelect")
          .addEventListener("change", fetchAttendanceStats);
      }

      async function fetchAttendanceStats() {
        try {
          showLoading();
          const token = localStorage.getItem("token");
          if (!token) {
            window.location.href =
              "index.html?error=" + encodeURIComponent("로그인이 필요합니다.");
            return;
          }

          const response = await axios.get("/api/attendance/stats", {
            params: {
              startDate: document.getElementById("startDate").value,
              endDate: document.getElementById("endDate").value,
              grade: document.getElementById("gradeSelect").value,
              classNum: document.getElementById("classSelect").value,
            },
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });

          if (!response.data.success) {
            throw new Error(
              response.data.message || "통계 조회에 실패했습니다."
            );
          }

          const { studentStats, overallStats, monthlyRankings } = response.data;

          // 각 데이터가 존재하는지 확인 후 업데이트
          if (overallStats) {
            updateOverallStats(overallStats);
          }

          if (studentStats) {
            updateStudentStats(studentStats);
          }

          if (monthlyRankings) {
            updateMonthlyStats(monthlyRankings);
          }
        } catch (error) {
          console.error("통계 조회 중 오류:", error);
          alert(error.message || "통계 조회 중 오류가 발생했습니다.");
        } finally {
          hideLoading();
        }
      }

      function updateOverallStats(stats) {
        document.getElementById(
          "totalStudents"
        ).textContent = `${stats.totalStudents}명`;
        document.getElementById(
          "attendanceRate"
        ).textContent = `${stats.averageAttendanceRate}%`;
        document.getElementById("lateRate").textContent = `${(
          (stats.totalLate /
            (stats.totalPresent + stats.totalLate + stats.totalAbsent)) *
          100
        ).toFixed(1)}%`;
        document.getElementById("absentRate").textContent = `${(
          (stats.totalAbsent /
            (stats.totalPresent + stats.totalLate + stats.totalAbsent)) *
          100
        ).toFixed(1)}%`;
        document.getElementById(
          "avgLateTime"
        ).textContent = `${(stats.totalLate > 0
          ? stats.totalLateMinutes / stats.totalLate
          : 0
        ).toFixed(1)}분`;
        document.getElementById("excusedRate").textContent = `${(
          (stats.totalExcused /
            (stats.totalPresent + stats.totalLate + stats.totalAbsent)) *
          100
        ).toFixed(1)}%`;

        // 전체 출석일수 계산 수정
        const totalDays =
          stats.totalPresent +
          stats.totalLate +
          stats.totalAbsent +
          stats.totalExcused;
        document.getElementById("totalDays").textContent = `${totalDays}일`;
      }

      function updateStudentStats(stats) {
        const tbody = document.getElementById("statsTableBody");
        tbody.innerHTML = stats
          .map((student) => {
            if (!student) return "";

            const { summary } = student;
            return `
              <tr class="hover:bg-gray-50 transition-colors">
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-medium">
                  ${student.studentId}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                  ${student.name}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                  ${student.grade}-${student.class}-${student.number}
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="flex items-center">
                    <div class="w-16 bg-gray-200 rounded-full h-2 mr-2">
                      <div
                        class="bg-green-500 rounded-full h-2"
                        style="width: ${summary.attendanceRate}%"
                      ></div>
                    </div>
                    <span class="text-sm font-medium text-gray-900">${
                      summary.attendanceRate
                    }%</span>
                  </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <div class="flex items-center space-x-2 text-sm">
                    <span class="text-green-600 font-medium">${
                      summary.presentCount
                    }</span>
                    <span class="text-gray-400">/</span>
                    <span class="text-yellow-600 font-medium">${
                      summary.lateCount
                    }</span>
                    <span class="text-gray-400">/</span>
                    <span class="text-red-600 font-medium">${
                      summary.absentCount
                    }</span>
                  </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                  ${
                    summary.lateCount > 0
                      ? `${(
                          summary.totalLateMinutes / summary.lateCount
                        ).toFixed(1)}분`
                      : "-"
                  }
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  ${
                    student.todayAttendance 
                      ? `<span class="${getStatusBadgeClass(student.todayAttendance.status)}">
                          ${getStatusText(student.todayAttendance.status)}
                          ${
                            student.todayAttendance.lateMinutes
                              ? `(${student.todayAttendance.lateMinutes}분)`
                              : ''
                          }
                          ${
                            student.todayAttendance.timestamp
                              ? `<br><span class="text-xs text-gray-500">
                                ${moment(student.todayAttendance.timestamp).format("HH:mm:ss")}
                              </span>`
                              : ''
                          }
                        </span>`
                      : '<span class="text-gray-400 text-sm">미출석</span>'
                  }
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <button
                    onclick="showStudentDetail('${student.studentId}')"
                    class="text-primary hover:text-secondary transition-colors inline-flex items-center text-sm font-medium"
                  >
                    <i class="ri-file-list-line mr-1"></i>
                    상세보기
                  </button>
                </td>
              </tr>
            `;
          })
          .join("");
      }

      function getStatusColor(status) {
        switch (status) {
          case "present":
            return "text-green-600";
          case "late":
            return "text-yellow-600";
          case "absent":
            return "text-red-600";
          case "excused":
            return "text-blue-600";
          default:
            return "text-gray-600";
        }
      }

      function updateSpecialStats(specialStats) {
        // 먼저 null 체크
        if (!specialStats) return;

        // 출석왕 TOP 3
        const attendanceKings = document.getElementById("attendanceKings");
        if (attendanceKings) {
          attendanceKings.innerHTML = specialStats.attendance
            .map(
              (student, index) => `
              <div class="flex items-center justify-between p-2 ${
                index === 0 ? "bg-green-100" : "bg-green-50"
              } rounded-lg">
                <div class="flex items-center">
                  <span class="text-lg font-bold mr-2">${index + 1}</span>
                  <div>
                    <p class="font-semibold">${student.grade}-${
                student.class
              } ${student.name}</p>
                    <p class="text-sm text-gray-600">${student.studentId}</p>
                  </div>
                </div>
                <div class="text-right">
                  <p class="font-bold text-green-700">${student.count}회</p>
                </div>
              </div>
            `
            )
            .join("");
        }

        // 개근상 TOP 3
        const improvementKings = document.getElementById("improvementKings");
        if (improvementKings) {
          improvementKings.innerHTML = specialStats.improvement
            .map(
              (student, index) => `
              <div class="flex items-center justify-between p-2 ${
                index === 0 ? "bg-purple-100" : "bg-purple-50"
              } rounded-lg">
                <div class="flex items-center">
                  <span class="text-lg font-bold mr-2">${index + 1}</span>
                  <div>
                    <p class="font-semibold">${student.grade}-${
                student.class
              } ${student.name}</p>
                    <p class="text-sm text-gray-600">${student.studentId}</p>
                  </div>
                </div>
                <div class="text-right">
                  <p class="font-bold text-purple-700">+${
                    student.improvement
                  }%</p>
                </div>
              </div>
            `
            )
            .join("");
        }

        // 개근상 후보
        const perfectAttendance = document.getElementById("perfectAttendance");
        if (perfectAttendance) {
          perfectAttendance.innerHTML =
            specialStats.attendance
              .filter((student) => student.count === moment().daysInMonth())
              .map(
                (student) => `
              <div class="flex items-center justify-between p-2 bg-yellow-50 rounded-lg">
                <div>
                  <p class="font-semibold">${student.grade}-${student.class} ${student.name}</p>
                  <p class="text-sm text-gray-600">${student.studentId}</p>
                </div>
                <div class="text-right">
                  <p class="font-bold text-yellow-700">100%</p>
                </div>
              </div>
            `
              )
              .join("") ||
            "<p class='text-center text-gray-500'>해당자 없음</p>";
        }
      }

      function updateAbsenceLists(excused, normal) {
        const excusedList = document.getElementById("excusedAbsencesList");
        const normalList = document.getElementById("absencesList");

        excusedList.innerHTML = excused
          .map(
            (absence) => `
          <div class="mb-2 p-2 bg-white rounded shadow">
            <p>학번: ${absence.studentId}</p>
            <p>날짜: ${moment(absence.timestamp).format("YYYY-MM-DD")}</p>
            <p>사유: ${absence.reason || "사유 없음"}</p>
          </div>
        `
          )
          .join("");

        normalList.innerHTML = normal
          .map(
            (absence) => `
          <div class="mb-2 p-2 bg-white rounded shadow">
            <p>학번: ${absence.studentId}</p>
            <p>날짜: ${moment(absence.timestamp).format("YYYY-MM-DD")}</p>
            <button
              onclick="handleExcuseAbsence('${absence.studentId}', '${
              absence.timestamp
            }')"
              class="mt-2 text-blue-600 hover:text-blue-800"
            >
              인정출결으로 변경
            </button>
          </div>
        `
          )
          .join("");
      }

      // 기존 인정출결 처리 이벤트 리스너
      document
        .getElementById("excuseForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          try {
            const response = await axios.post(
              "/api/attendance/excuse",
              {
                studentId: document.getElementById("excuseStudentId").value,
                date: document.getElementById("excuseDate").value,
                reason: document.getElementById("excuseReason").value,
              },
              {
                headers: {
                  Authorization: `Bearer ${localStorage.getItem("token")}`,
                },
              }
            );

            showToast(response.data.message, "success");
            document.getElementById("excuseForm").reset();
            await updateExcusedList();
          } catch (error) {
            showToast(
              error.response?.data?.message ||
                "인정출결 처리 중 오류가 발생했습니다.",
              "error"
            );
          }
        });

      // 단체 인정출결 처리 이벤트 리스너 추가
      document
        .getElementById("groupExcuseForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          try {
            const filters = {
              grade: document.getElementById("groupExcuseGrade").value,
              class: document.getElementById("groupExcuseClass").value,
            };

            // 필터 값이 비어있으면 해당 속성 제거
            if (!filters.grade) delete filters.grade;
            if (!filters.class) delete filters.class;

            const response = await axios.post(
              "/api/attendance/excuse-group",
              {
                date: document.getElementById("groupExcuseDate").value,
                reason: document.getElementById("groupExcuseReason").value,
                filters,
              },
              {
                headers: {
                  Authorization: `Bearer ${localStorage.getItem("token")}`,
                },
              }
            );

            showToast(response.data.message, "success");
            document.getElementById("groupExcuseForm").reset();
            await updateExcusedList();
          } catch (error) {
            showToast(
              error.response?.data?.message ||
                "단체 인정출결 처리 중 오류가 발생했습니다.",
              "error"
            );
          }
        });

      // 인정출결 취소 함수 추가
      async function cancelExcusedAbsence(id) {
        if (!confirm("이 인정출결을 취소하시겠습니까?")) return;

        try {
          const response = await axios.delete(`/api/attendance/excuse/${id}`, {
            headers: {
              Authorization: `Bearer ${localStorage.getItem("token")}`,
            },
          });

          showToast(response.data.message, "success");
          await updateExcusedList();
        } catch (error) {
          showToast(
            error.response?.data?.message ||
              "인정출결 취소 중 오류가 발생했습니다.",
            "error"
          );
        }
      }

      // 인정출결 목록 업데이트 함수 수정
      async function updateExcusedList() {
        try {
          const response = await axios.get("/api/attendance/excused", {
            headers: {
              Authorization: `Bearer ${localStorage.getItem("token")}`,
            },
          });

          const excusedList = document.getElementById("excusedList");
          if (excusedList) {
            excusedList.innerHTML =
              response.data.excused
                .map(
                  (item) => `
              <div class="bg-white p-3 rounded-lg shadow-sm mb-2">
                <div class="flex justify-between items-start">
                  <div>
                    <p class="font-semibold">${item.studentName} (${
                    item.studentId
                  })</p>
                    <p class="text-sm text-gray-600">${moment(item.date).format(
                      "YYYY년 MM월 DD일 (ddd)"
                    )}</p>
                    <p class="text-sm text-gray-700 mt-1">${item.reason}</p>
                  </div>
                  <div class="flex flex-col items-end">
                    <span class="text-xs text-gray-500">
                      ${moment(item.excusedAt).format("YYYY-MM-DD HH:mm")}
                    </span>
                    <button 
                      onclick="cancelExcusedAbsence('${item._id}')"
                      class="mt-2 text-red-600 hover:text-red-800 text-sm"
                    >
                      <i class="ri-delete-bin-line mr-1"></i>취소
                    </button>
                  </div>
                </div>
              </div>
            `
                )
                .join("") ||
              '<p class="text-center text-gray-500">인정출결 기록이 없습니다.</p>';
          }
        } catch (error) {
          console.error("인정출결 목록 조회 중 오류:", error);
          showToast("인정출결 목록 조회에 실패했습니다.", "error");
        }
      }

      // 토스트 메시지 표시 함수
      function showToast(message, type = "info") {
        const toast = document.createElement("div");
        toast.className = `fixed bottom-4 right-4 p-4 rounded-lg ${
          type === "error" ? "bg-red-500" : "bg-green-500"
        } text-white shadow-lg z-50 transition-opacity duration-300`;
        toast.textContent = message;

        document.body.appendChild(toast);
        setTimeout(() => {
          toast.style.opacity = "0";
          setTimeout(() => toast.remove(), 300);
        }, 3000);
      }

      axios.interceptors.response.use(
        (response) => response,
        async (error) => {
          const originalRequest = error.config;

          if (error.response) {
            // 서버 응답이 있는 경우
            switch (error.response.status) {
              case 401:
                // 토큰이 만료되었고, 재시도하지 않은 요청인 경우
                if (!originalRequest._retry) {
                  originalRequest._retry = true;

                  try {
                    const refreshToken = localStorage.getItem("refreshToken");
                    if (!refreshToken) {
                      throw new Error("리프레시 토큰이 없습니다.");
                    }

                    // 토큰 갱신 요청
                    const response = await axios.post("/api/refresh-token", {
                      refreshToken,
                    });

                    if (!response.data.success) {
                      throw new Error(response.data.message);
                    }

                    // 새로운 토토큰 저장
                    localStorage.setItem("token", response.data.accessToken);
                    localStorage.setItem(
                      "refreshToken",
                      response.data.refreshToken
                    );
                    localStorage.setItem(
                      "userInfo",
                      JSON.stringify(response.data.user)
                    );

                    // 원래 요청 헤더 업데이트
                    originalRequest.headers.Authorization = `Bearer ${response.data.accessToken}`;

                    // 원래 요청 재시도
                    return axios(originalRequest);
                  } catch (error) {
                    console.error("Token refresh failed:", error);
                    localStorage.clear();
                    window.location.href =
                      "index.html?error=" +
                      encodeURIComponent(
                        "세션이 만료되었습니다. 다시 로그인해주세요."
                      );
                    return Promise.reject(error);
                  }
                }
                break;
              case 403:
                showToast("권한이 없습니다.", "error");
                break;
              case 404:
                showToast("요청한 리소스를 찾을 수 없습니다.", "error");
                break;
              case 500:
                showToast("서버 오류가 발생했습니다.", "error");
                break;
              default:
                showToast("요청 처리 중 오류가 발생했습니다.", "error");
            }
          } else if (error.request) {
            // 요청은 보냈지만 응답을 받지 못한 경우
            showToast("서버와 통신할 수 없습니다.", "error");
          } else {
            // 요청 설정 중 오류 발생
            showToast("요청을 보내는 중 오류가 발생했습니다.", "error");
          }
          return Promise.reject(error);
        }
      );

      document.addEventListener("DOMContentLoaded", () => {
        const today = moment().format("YYYY-MM-DD");
        const firstDayOfMonth = moment().startOf("month").format("YYYY-MM-DD");

        document.getElementById("startDate").value = firstDayOfMonth;
        document.getElementById("endDate").value = today;

        fetchAttendanceStats();
      });

      function updateMonthlyStats(rankings) {
        if (!rankings) return;

        // 출석왕 TOP 3
        const attendanceKings = document.getElementById("attendanceKings");
        if (attendanceKings && rankings.attendance) {
          attendanceKings.innerHTML =
            rankings.attendance
              .map(
                (student, index) => `
              <div class="flex items-center justify-between p-2 ${
                index === 0 ? "bg-green-100" : "bg-green-50"
              } rounded-lg">
                <div class="flex items-center">
                  <span class="text-lg font-bold mr-2">${index + 1}</span>
                  <div>
                    <p class="font-semibold">${student.grade}-${
                  student.class
                } ${student.name}</p>
                    <p class="text-sm text-gray-600">${student.studentId}</p>
                  </div>
                </div>
                <div class="text-right">
                  <p class="font-bold text-green-700">${student.count}회</p>
                </div>
              </div>
            `
              )
              .join("") ||
            "<p class='text-center text-gray-500'>데이터가 없습니다.</p>";
        }

        // 지각왕 TOP 3
        const lateKings = document.getElementById("lateKings");
        if (lateKings && rankings.lateKings) {
          lateKings.innerHTML =
            rankings.lateKings
              .map(
                (student, index) => `
              <div class="flex items-center justify-between p-2 ${
                index === 0 ? "bg-yellow-100" : "bg-yellow-50"
              } rounded-lg">
                <div class="flex items-center">
                  <span class="text-lg font-bold mr-2">${index + 1}</span>
                  <div>
                    <p class="font-semibold">${student.grade}-${
                  student.class
                } ${student.name}</p>
                    <p class="text-sm text-gray-600">${student.studentId}</p>
                  </div>
                </div>
                <div class="text-right">
                  <p class="font-bold text-yellow-700">${student.count}회</p>
                  <p class="text-sm text-yellow-600">${
                    student.lateMinutes
                  }분</p>
                </div>
              </div>
            `
              )
              .join("") ||
            "<p class='text-center text-gray-500'>데이터가 없습니다.</p>";
        }

        // 개선왕 TOP 3
        const improvementKings = document.getElementById("improvementKings");
        if (improvementKings && rankings.improvement) {
          improvementKings.innerHTML =
            rankings.improvement
              .map(
                (student, index) => `
              <div class="flex items-center justify-between p-2 ${
                index === 0 ? "bg-purple-100" : "bg-purple-50"
              } rounded-lg">
                <div class="flex items-center">
                  <span class="text-lg font-bold mr-2">${index + 1}</span>
                  <div>
                    <p class="font-semibold">${student.grade}-${
                  student.class
                } ${student.name}</p>
                    <p class="text-sm text-gray-600">${student.studentId}</p>
                  </div>
                </div>
                <div class="text-right">
                  <p class="font-bold text-purple-700">${
                    student.improvement > 0 ? "+" : ""
                  }${student.improvement}%</p>
                </div>
              </div>
            `
              )
              .join("") ||
            "<p class='text-center text-gray-500'>데이터가 없습니다.</p>";
        }
      }

      // 상세 보기 버튼 클릭 이벤트 처리
      async function showStudentDetail(studentId) {
        try {
          showLoading();
          const response = await axios.get(
            `/api/attendance/student/${studentId}`,
            {
              headers: {
                Authorization: `Bearer ${localStorage.getItem("token")}`,
              },
            }
          );

          if (!response.data.success) {
            throw new Error(
              response.data.message || "상세 정보 조회에 실패했습니다."
            );
          }

          updateStudentDetailModal(response.data);
          document
            .getElementById("studentDetailModal")
            .classList.remove("hidden");
        } catch (error) {
          console.error("상세 정보 조회 중 오류:", error);
          showToast(error.message || "상세 정보 조회에 실패했습니다.", "error");
        } finally {
          hideLoading();
        }
      }

      // 모달 관련 함수들 가
      function updateStudentDetailModal(data) {
        if (!data) return;

        const {
          student,
          totalStats,
          monthlyStats,
          improvements,
          attendances,
          todayStatus,
        } = data;

        try {
          // 기본 정보 업데이트
          document.getElementById(
            "modalTitle"
          ).textContent = `${student.name} 학생 상세 통계`;
          document.getElementById("modalStudentId").textContent =
            student.studentId;
          document.getElementById("modalStudentName").textContent =
            student.name;
          document.getElementById(
            "modalStudentClass"
          ).textContent = `${student.grade}-${student.class}`;
          document.getElementById("modalStudentNumber").textContent =
            student.number;

          // 오늘의 출석 상태 업데이트
          const modalTodayStatus = document.getElementById("modalTodayStatus");
          if (modalTodayStatus) {
            modalTodayStatus.innerHTML = todayStatus
              ? `
                <div class="bg-gray-50 p-4 rounded-lg mb-4">
                  <h4 class="text-lg font-semibold mb-2">늘의 출석 상태</h4>
                  <div class="flex items-center space-x-4">
                    <span class="${getStatusBadgeClass(todayStatus.status)}">
                      ${getStatusText(todayStatus.status)}
                      ${
                        todayStatus.lateMinutes
                          ? `(${todayStatus.lateMinutes}분)`
                          : ""
                      }
                    </span>
                    ${
                      todayStatus.isExcused
                        ? `<span class="text-blue-600">인정출결</span>
                         <span class="text-sm text-gray-500">${
                           todayStatus.reason || ""
                         }</span>`
                        : ""
                    }
                  </div>
                </div>
              `
              : '<div class="text-gray-500">오늘의 출석 정보가 없습니다.</div>';
          }

          // 전체 통계 요약 업데이트
          const modalSummary = document.getElementById("modalSummary");
          if (modalSummary && totalStats) {
            modalSummary.innerHTML = `
              <div class="flex flex-wrap gap-4">
                <!-- 출석률 카드 -->
                <div class="flex-1 min-w-[240px] bg-gradient-to-br from-green-50 to-green-100 p-6 rounded-xl shadow-sm">
                  <div class="flex flex-col">
                    <h5 class="text-sm font-semibold text-green-800 mb-1">출석률</h5>
                    <p class="text-3xl font-bold text-green-700 mb-2">${
                      totalStats.attendanceRate
                    }%</p>
                    <div class="flex items-center text-green-600">
                      <i class="ri-checkbox-circle-line mr-1"></i>
                      <span class="text-sm">${totalStats.present}회</span>
                    </div>
                  </div>
                </div>

                <!-- 지각률 카드 -->
                <div class="flex-1 min-w-[240px] bg-gradient-to-br from-yellow-50 to-yellow-100 p-6 rounded-xl shadow-sm">
                  <div class="flex flex-col">
                    <h5 class="text-sm font-semibold text-yellow-800 mb-1">지각률</h5>
                    <p class="text-3xl font-bold text-yellow-700 mb-2">${(
                      (totalStats.late / totalStats.total) *
                      100
                    ).toFixed(1)}%</p>
                    <div class="flex items-center text-yellow-600">
                      <i class="ri-time-line mr-1"></i>
                      <span class="text-sm">${totalStats.late}회 (평균 ${(
              totalStats.lateMinutes / totalStats.late || 0
            ).toFixed(1)}분)</span>
                    </div>
                  </div>
                </div>

                <!-- 결석률 카드 -->
                <div class="flex-1 min-w-[240px] bg-gradient-to-br from-red-50 to-red-100 p-6 rounded-xl shadow-sm">
                  <div class="flex flex-col">
                    <h5 class="text-sm font-semibold text-red-800 mb-1">결석률</h5>
                    <p class="text-3xl font-bold text-red-700 mb-2">${(
                      (totalStats.absent / totalStats.total) *
                      100
                    ).toFixed(1)}%</p>
                    <div class="flex items-center text-red-600">
                      <i class="ri-close-circle-line mr-1"></i>
                      <span class="text-sm">${totalStats.absent}회</span>
                    </div>
                  </div>
                </div>

                <!-- 인정출결 카드 -->
                <div class="flex-1 min-w-[240px] bg-gradient-to-br from-blue-50 to-blue-100 p-6 rounded-xl shadow-sm">
                  <div class="flex flex-col">
                    <h5 class="text-sm font-semibold text-blue-800 mb-1">인정출결</h5>
                    <p class="text-3xl font-bold text-blue-700 mb-2">${
                      totalStats.excused
                    }회</p>
                    <div class="flex items-center text-blue-600">
                      <i class="ri-calendar-check-line mr-1"></i>
                      <span class="text-sm">${(
                        (totalStats.excused / totalStats.total) *
                        100
                      ).toFixed(1)}%</span>
                    </div>
                  </div>
                </div>
              </div>

              <!-- 출석 진행도 -->
              <div class="mt-6 bg-white p-6 rounded-xl shadow-sm">
                <h5 class="text-sm font-semibold text-gray-800 mb-3">전체 출석 현황</h5>
                <div class="relative pt-1">
                  <div class="flex mb-2 items-center justify-between">
                    <div>
                      <span class="text-xs font-semibold inline-block py-1 px-2 uppercase rounded-full text-green-600 bg-green-100">
                        진행률
                      </span>
                    </div>
                    <div class="text-right">
                      <span class="text-xs font-semibold inline-block text-green-600">
                        ${totalStats.total}일 중 ${totalStats.present}일 출석
                      </span>
                    </div>
                  </div>
                  <div class="flex h-2 mb-4 overflow-hidden rounded-full bg-gray-100">
                    <div style="width:${
                      totalStats.attendanceRate
                    }%" class="bg-green-500"></div>
                    <div style="width:${(
                      (totalStats.late / totalStats.total) *
                      100
                    ).toFixed(1)}%" class="bg-yellow-500"></div>
                    <div style="width:${(
                      (totalStats.absent / totalStats.total) *
                      100
                    ).toFixed(1)}%" class="bg-red-500"></div>
                    <div style="width:${(
                      (totalStats.excused / totalStats.total) *
                      100
                    ).toFixed(1)}%" class="bg-blue-500"></div>
                  </div>
                  <div class="flex justify-between text-xs text-gray-600">
                    <span class="flex items-center"><span class="w-2 h-2 bg-green-500 rounded-full mr-1"></span> 출석</span>
                    <span class="flex items-center"><span class="w-2 h-2 bg-yellow-500 rounded-full mr-1"></span> 지각</span>
                    <span class="flex items-center"><span class="w-2 h-2 bg-red-500 rounded-full mr-1"></span> 결석</span>
                    <span class="flex items-center"><span class="w-2 h-2 bg-blue-500 rounded-full mr-1"></span> 인정출결</span>
                  </div>
                </div>
              </div>
            `;
          }

          // 차트와 테이블 업데이트
          if (monthlyStats) updateMonthlyStatsChart(monthlyStats);
          if (attendances) updateAttendanceTable(attendances);
          if (improvements) updateImprovementChart(improvements);
        } catch (error) {
          console.error("모달 업데이트 중 오류:", error);
          showToast("상세 정보 표시 중 오류가 발생했습니다.", "error");
        }
      }

      // 출석 기록을 월별로 그룹화하는 함수
      function groupAttendancesByMonth(attendances) {
        return attendances.reduce((groups, attendance) => {
          const month = moment(attendance.date).format("YYYY년 MM월");
          if (!groups[month]) {
            groups[month] = [];
          }
          groups[month].push(attendance);
          return groups;
        }, {});
      }

      // 차석 기록 테이블 업데이트 함수 개선
      function updateAttendanceTable(attendances) {
        const tableBody = document.getElementById("modalAttendanceList");
        tableBody.innerHTML = attendances
          .map(
            (attendance) => `
              <tr class="hover:bg-gray-50 transition-colors">
                <td class="px-6 py-4 whitespace-nowrap">
                  ${moment(attendance.date).format("YYYY년 MM월 DD일 (ddd)")}
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  <span class="${getStatusBadgeClass(attendance.status)}">
                    ${getStatusText(attendance.status)}
                  </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                  ${
                    attendance.lateMinutes ? `${attendance.lateMinutes}분` : "-"
                  }
                </td>
              </tr>
            `
          )
          .join("");
      }

      // 월 통계 계산 함수
      function calculateMonthStats(records) {
        return {
          present: records.filter((r) => r.status === "present").length,
          late: records.filter((r) => r.status === "late").length,
          absent: records.filter((r) => r.status === "absent" && !r.isExcused)
            .length,
          excused: records.filter((r) => r.isExcused).length,
        };
      }

      // 차트 정 개선
      const chartConfig = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: "bottom",
            labels: {
              usePointStyle: true,
              padding: 20,
              font: {
                family: "'Inter', sans-serif",
                size: 12,
              },
            },
          },
          tooltip: {
            mode: "index",
            intersect: false,
            padding: 12,
            backgroundColor: "rgba(17, 24, 39, 0.8)",
            titleFont: {
              size: 14,
              weight: "bold",
              family: "'Inter', sans-serif",
            },
            bodyFont: {
              size: 13,
              family: "'Inter', sans-serif",
            },
            callbacks: {
              title: function (tooltipItems) {
                return moment(tooltipItems[0].label).format("YYYY년 MM월");
              },
              label: function (context) {
                const label = context.dataset.label || "";
                const value = context.parsed.y || 0;
                return `${label}: ${value}${context.dataset.unit || ""}`;
              },
            },
          },
        },
        scales: {
          x: {
            grid: {
              display: false,
            },
            ticks: {
              callback: function (value, index) {
                return moment(this.getLabelForValue(value)).format("MM월");
              },
              font: {
                family: "'Inter', sans-serif",
                size: 12,
              },
            },
          },
          y: {
            beginAtZero: true,
            grid: {
              color: "rgba(0, 0, 0, 0.1)",
              drawBorder: false,
            },
            ticks: {
              font: {
                family: "'Inter', sans-serif",
                size: 12,
              },
              padding: 8,
              stepSize: 1,
            },
          },
        },
      };

      // 차트 초기화 함수 개선
      async function initializeCharts() {
        if (typeof Chart === "undefined") {
          await new Promise((resolve, reject) => {
            const script = document.createElement("script");
            script.src = "https://cdn.jsdelivr.net/npm/chart.js";
            script.onload = resolve;
            script.onerror = reject;
            document.head.appendChild(script);
          });
        }

        // 차트 기본 설정 수정
        Chart.defaults.font.family = "'Inter', sans-serif";
        Chart.defaults.color = "#374151";
        Chart.defaults.plugins.tooltip.backgroundColor =
          "rgba(17, 24, 39, 0.8)";
        Chart.defaults.plugins.tooltip.titleFont.size = 14;
        Chart.defaults.plugins.tooltip.bodyFont.size = 13;
      }

      // 차트 업데이트 시 애니메이션 설정
      const chartAnimationOptions = {
        animation: {
          duration: 750,
          easing: "easeOutQuart",
        },
        transitions: {
          active: {
            animation: {
              duration: 200,
            },
          },
        },
      };

      // 차트 색상 테마
      const chartColors = {
        present: {
          background: "rgba(34, 197, 94, 0.5)",
          border: "rgb(34, 197, 94)",
        },
        late: {
          background: "rgba(234, 179, 8, 0.5)",
          border: "rgb(234, 179, 8)",
        },
        absent: {
          background: "rgba(239, 68, 68, 0.5)",
          border: "rgb(239, 68, 68)",
        },
        excused: {
          background: "rgba(59, 130, 246, 0.5)",
          border: "rgb(59, 130, 246)",
        },
        improvement: {
          background: "rgba(147, 51, 234, 0.1)",
          border: "rgb(147, 51, 234)",
        },
      };

      // 상태 텍스트 변환 함수
      function getStatusText(status) {
        switch (status) {
          case "present":
            return "출석";
          case "late":
            return "지각";
          case "absent":
            return "결석";
          case "excused":
            return "인정출결";
          default:
            return "미확인";
        }
      }

      // 모달 닫기 함수 개선
      function closeModal() {
        const modal = document.getElementById("studentDetailModal");
        if (modal) {
          modal.classList.add("hidden");
          document.body.style.overflow = ""; // 배경 스크롤 복원

          // 차트 정리
          if (window.monthlyChart instanceof Chart) {
            window.monthlyChart.destroy();
          }
          if (window.improvementChart instanceof Chart) {
            window.improvementChart.destroy();
          }
        }
      }

      // ESC 키로 모달 닫기
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          closeModal();
        }
      });

      // 차트.js 라이브러리 추가
      const script = document.createElement("script");
      script.src = "https://cdn.jsdelivr.net/npm/chart.js";
      document.head.appendChild(script);

      // 상태별 배지 스타일 클래스
      function getStatusBadgeClass(status) {
        const baseClasses = "inline-flex flex-col items-center px-3 py-1 rounded-full text-sm font-medium";
        switch (status) {
          case "present":
            return `${baseClasses} bg-green-100 text-green-800`;
          case "late":
            return `${baseClasses} bg-yellow-100 text-yellow-800`;
          case "absent":
            return `${baseClasses} bg-red-100 text-red-800`;
          case "excused":
            return `${baseClasses} bg-blue-100 text-blue-800`;
          default:
            return `${baseClasses} bg-gray-100 text-gray-800`;
        }
      }

      // 월별 통계 차트 업데이트 최적화
      const chartUpdateQueue = new Set();

      function queueChartUpdate(chartId, updateFn) {
        if (chartUpdateQueue.has(chartId)) {
          return;
        }

        chartUpdateQueue.add(chartId);
        requestAnimationFrame(() => {
          updateFn();
          chartUpdateQueue.delete(chartId);
        });
      }

      // 차트 업데이트 함수 수정
      async function updateMonthlyStatsChart(monthlyStats) {
        if (!monthlyStats) return;

        const canvas = document.getElementById("monthlyStatsChart");
        if (!canvas) return;

        // canvas 컨텍스트 가져오기
        const ctx = canvas.getContext("2d");
        if (!ctx) return;

        // 기존 차트 제거
        if (window.monthlyChart instanceof Chart) {
          window.monthlyChart.destroy();
        }

        const months = Object.keys(monthlyStats);
        const datasets = [
          {
            label: "출석",
            data: months.map((month) => monthlyStats[month].present),
            backgroundColor: chartColors.present.background,
            borderColor: chartColors.present.border,
            borderWidth: 2,
            unit: "회",
          },
          {
            label: "지각",
            data: months.map((month) => monthlyStats[month].late),
            backgroundColor: chartColors.late.background,
            borderColor: chartColors.late.border,
            borderWidth: 2,
            unit: "회",
            stack: "Stack 0",
          },
          {
            label: "결석",
            data: months.map((month) => monthlyStats[month].absent),
            backgroundColor: chartColors.absent.background,
            borderColor: chartColors.absent.border,
            borderWidth: 2,
            unit: "회",
            stack: "Stack 0",
          },
          {
            label: "인정출결",
            data: months.map((month) => monthlyStats[month].excused),
            backgroundColor: chartColors.excused.background,
            borderColor: chartColors.excused.border,
            borderWidth: 2,
            unit: "회",
            stack: "Stack 0",
          },
        ];

        window.monthlyChart = new Chart(ctx, {
          type: "bar",
          data: { labels: months, datasets },
          options: {
            ...chartConfig,
            plugins: {
              ...chartConfig.plugins,
              title: {
                display: true,
                text: "월별 출석 현황",
                font: {
                  size: 16,
                  weight: "bold",
                  family: "'Inter', sans-serif",
                },
              },
            },
            scales: {
              ...chartConfig.scales,
              y: {
                ...chartConfig.scales.y,
                stacked: true,
              },
            },
          },
        });
      }

      // 개선도 차트 업데이트 함수
      async function updateImprovementChart(improvements) {
        if (!improvements || improvements.length === 0) return;

        const ctx = document.getElementById("improvementChart");
        if (!ctx) return;

        // 기존 차트 제거
        if (window.improvementChart instanceof Chart) {
          window.improvementChart.destroy();
        }

        const labels = improvements.map((imp) => imp.month);
        const data = improvements.map((imp) => imp.improvement);

        const config = {
          type: "line",
          data: {
            labels: labels,
            datasets: [
              {
                label: "개선도",
                data: data,
                borderColor: chartColors.improvement.border,
                backgroundColor: chartColors.improvement.background,
                tension: 0.3,
                fill: true,
                pointBackgroundColor: data.map((value) =>
                  value >= 0
                    ? chartColors.present.border
                    : chartColors.absent.border
                ),
                pointRadius: 5,
                pointHoverRadius: 7,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: "bottom",
                labels: {
                  usePointStyle: true,
                  padding: 20,
                  font: {
                    family: "'Inter', sans-serif",
                    size: 12,
                  },
                },
              },
              tooltip: {
                mode: "index",
                intersect: false,
                padding: 12,
                backgroundColor: "rgba(17, 24, 39, 0.8)",
                callbacks: {
                  label: (context) => `개선도: ${context.parsed.y}%`,
                },
              },
            },
            scales: {
              y: {
                beginAtZero: true,
                grid: {
                  color: "rgba(0, 0, 0, 0.05)",
                  drawBorder: false,
                },
                ticks: {
                  callback: (value) => `${value}%`,
                  stepSize: 10,
                  font: {
                    family: "'Inter', sans-serif",
                    size: 12,
                  },
                },
              },
              x: {
                grid: {
                  display: false,
                },
                ticks: {
                  font: {
                    family: "'Inter', sans-serif",
                    size: 12,
                  },
                },
              },
            },
          },
        };
      }

      function showLoading() {
        const loadingSpinner = document.getElementById("loading-spinner");
        if (loadingSpinner) {
          loadingSpinner.classList.remove("hidden");
        }
      }

      function hideLoading() {
        const loadingSpinner = document.getElementById("loading-spinner");
        if (loadingSpinner) {
          loadingSpinner.classList.add("hidden");
        }
      }

      // 전역 에러 핸들러 추가
      window.onerror = function (msg, url, lineNo, columnNo, error) {
        console.error("Global error:", { msg, url, lineNo, columnNo, error });
        showToast("예기치 않은 류가 발생했습니다.", "error");
        return false;
      };

      // Axios 인터셉터 에러 처리 개선
      axios.interceptors.response.use(
        (response) => response,
        async (error) => {
          const originalRequest = error.config;

          if (error.response) {
            // 서버 응답이 있는 경우
            switch (error.response.status) {
              case 401:
                // 토큰이 만료되었고, 재시도하지 않은 요청인 경우
                if (!originalRequest._retry) {
                  originalRequest._retry = true;

                  try {
                    const refreshToken = localStorage.getItem("refreshToken");
                    if (!refreshToken) {
                      throw new Error("리프레시 토큰이 없습니다.");
                    }

                    // 토큰 갱신 요청
                    const response = await axios.post("/api/refresh-token", {
                      refreshToken,
                    });

                    if (!response.data.success) {
                      throw new Error(response.data.message);
                    }

                    // 새로운 토토큰 저장
                    localStorage.setItem("token", response.data.accessToken);
                    localStorage.setItem(
                      "refreshToken",
                      response.data.refreshToken
                    );
                    localStorage.setItem(
                      "userInfo",
                      JSON.stringify(response.data.user)
                    );

                    // 원래 요청 헤더 업데이트
                    originalRequest.headers.Authorization = `Bearer ${response.data.accessToken}`;

                    // 원래 요청 재시도
                    return axios(originalRequest);
                  } catch (error) {
                    console.error("Token refresh failed:", error);
                    localStorage.clear();
                    window.location.href =
                      "index.html?error=" +
                      encodeURIComponent(
                        "세션이 만료되었습니다. 다시 로그인해주세요."
                      );
                    return Promise.reject(error);
                  }
                }
                break;
              case 403:
                showToast("권한이 없습니다.", "error");
                break;
              case 404:
                showToast("요청한 리소스를 찾을 수 없습니다.", "error");
                break;
              case 500:
                showToast("서버 오류가 발생했습니다.", "error");
                break;
              default:
                showToast("요청 처리 중 오류가 발생했습니다.", "error");
            }
          } else if (error.request) {
            // 요청은 보냈지만 응답을 받지 못한 경우
            showToast("서버와 통신할 수 없습니다.", "error");
          } else {
            // 요청 설정 중 오류 발생
            showToast("요청을 보내는 중 오류가 발생했습니다.", "error");
          }
          return Promise.reject(error);
        }
      );

      function showModal() {
        const modal = document.getElementById("studentDetailModal");
        if (modal) {
          modal.classList.remove("hidden");
          document.body.style.overflow = "hidden"; // 배경 스크롤 방지
        }
      }

      // 휴일 관리 관련 함수들 수정
      async function fetchHolidays() {
        try {
          const response = await axios.get("/api/holidays", {
            headers: {
              Authorization: `Bearer ${localStorage.getItem("token")}`,
            },
          });

          console.log("Holiday response:", response.data); //디버깅용 로그
          updateHolidayList(response.data.holidays);
        } catch (error) {
          console.error("휴일 목록 조회 중 오류:", error);
          showToast("휴일 목록 조회에 실패했습니다.", "error");
        }
      }

      function updateHolidayList(holidays) {
        const holidayList = document.getElementById("holidayList");
        if (!holidayList) return;

        if (!holidays || holidays.length === 0) {
          holidayList.innerHTML =
            '<p class="text-center text-gray-500">등록된 휴일이 없습니다.</p>';
          return;
        }

        holidayList.innerHTML = holidays
          .map(
            (holiday) => `
            <div class="bg-white p-3 rounded-lg shadow-sm mb-2">
              <div class="flex justify-between items-start">
                <div>
                  <p class="font-semibold">${moment(holiday.date).format(
                    "YYYY년 MM월 DD일 (ddd)"
                  )}</p>
                  <p class="text-sm text-gray-700">${holiday.reason}</p>
                  <p class="text-xs text-gray-500">등록: ${moment(
                    holiday.createdAt
                  ).format("YYYY년 MM월 DD일 HH시 mm분")}</p>
                  <p class="text-xs text-gray-500">등록자: ${
                    holiday.createdBy
                  }</p>
                </div>
                <button
                  onclick="deleteHoliday('${holiday.id}')"
                  class="text-red-600 hover:text-red-800 text-sm"
                >
                  <i class="ri-delete-bin-line"></i>
                </button>
              </div>
            </div>
          `
          )
          .join("");
      }

      // 휴일 등록 폼 이벤트 리스너 수정
      const holidayForm = document.getElementById("holidayForm");
      if (holidayForm) {
        holidayForm.addEventListener("submit", async (e) => {
          e.preventDefault();

          const date = document.getElementById("holidayDate").value;
          const reason = document.getElementById("holidayReason").value;

          if (!date || !reason) {
            showToast("날짜와 사유를 모두 입력해주세요.", "error");
            return;
          }

          try {
            const response = await axios.post(
              "/api/holidays",
              { date, reason },
              {
                headers: {
                  Authorization: `Bearer ${localStorage.getItem("token")}`,
                },
              }
            );

            showToast("휴일이 등록되었습니다.", "success");
            holidayForm.reset();
            await fetchHolidays(); // 목록 새로고침
          } catch (error) {
            console.error("휴일 등록 중 오류:", error);
            showToast(
              error.response?.data?.message || "휴일 등록에 실패했습니다.",
              "error"
            );
          }
        });
      }

      // 페휴일 삭제 함수 추가
      async function deleteHoliday(holidayId) {
        if (!confirm("정말 이 휴일을 삭제하시겠습니까?")) return;

        try {
          const response = await axios.delete(`/api/holidays/${holidayId}`, {
            headers: {
              Authorization: `Bearer ${localStorage.getItem("token")}`,
            },
          });

          showToast("휴일이 삭제되었습니다.", "success");
          await fetchHolidays(); // 목록 새로고침
        } catch (error) {
          console.error("휴일 삭제 중 오류:", error);
          showToast(
            error.response?.data?.message || "휴일 삭제에 실패했습니다.",
            "error"
          );
        }
      }

      // 페이지 로드 시 휴일 목록 조회
      document.addEventListener("DOMContentLoaded", async () => {
        try {
          await Promise.all([
            fetchAttendanceStats(),
            updateExcusedList(),
            fetchHolidays(), // 휴일 목록 조회
          ]);
        } catch (error) {
          console.error("초기화 중 오류:", error);
          showToast("데이터 로딩 중 오류가 발생했습니다.", "error");
        }
      });
    </script>
  </body>
</html>
