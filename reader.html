<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>완도고 출결관리 시스템</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-100 flex items-center justify-center min-h-screen">
    <div class="bg-white p-8 rounded-lg shadow-md text-center max-w-md w-full">
      <h1 class="text-2xl font-bold mb-6 text-gray-800">QR 코드 출석 확인</h1>
      <div id="qr-reader" class="mx-auto mb-4"></div>
      <div
        id="scan-result"
        class="text-lg font-semibold text-gray-700 mb-4"
      ></div>
      <div
        id="attendance-log"
        class="text-sm text-gray-600 mb-4 h-40 overflow-y-auto"
      ></div>
      <button
        id="stop-button"
        class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded"
      >
        스캔 중지
      </button>
    </div>

    <script>
      const html5QrCode = new Html5Qrcode("qr-reader");
      const scanResult = document.getElementById("scan-result");
      const attendanceLog = document.getElementById("attendance-log");
      const stopButton = document.getElementById("stop-button");
      let lastScannedCode = "";
      let scanTimeout = null;

      const qrCodeSuccessCallback = (decodedText, decodedResult) => {
        if (decodedText !== lastScannedCode) {
          lastScannedCode = decodedText;
          clearTimeout(scanTimeout);

          scanResult.innerText = `QR 코드 스캔 완료. 처리 중...`;
          scanResult.classList.remove("text-red-600", "text-green-600");
          scanResult.classList.add("text-blue-600");

          sendAttendance(decodedText);

          scanTimeout = setTimeout(() => {
            lastScannedCode = "";
          }, 5000); // 5초 후에 같은 코드를 다시 스캔할 수 있도록 함
        }
      };

      const config = { fps: 10, qrbox: { width: 250, height: 250 } };

      html5QrCode.start(
        { facingMode: "environment" },
        config,
        qrCodeSuccessCallback
      );

      const userInfo = JSON.parse(localStorage.getItem("userInfo"));

      if (!userInfo || !userInfo.isReader) {
        const errorMessage = encodeURIComponent("리더 권한이 필요합니다.");
        window.location.href = `hub.html?error=${errorMessage}`;
      }

      async function sendAttendance(encryptedData) {
        try {
          const token = localStorage.getItem("token");
          const response = await fetch(
            "https://port-0-attend-backend-lz9cd9taff85e9dc.sel4.cloudtype.app/api/attendance",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
              body: JSON.stringify({ encryptedData }),
            }
          );

          const data = await response.json();

          if (!response.ok) {
            throw new Error(data.message || "출석 처리에 실패했습니다.");
          }

          console.log("출석 처리 성공:", data);
          scanResult.innerText = data.message;
          scanResult.classList.remove("text-red-600", "text-blue-600");
          scanResult.classList.add(
            data.isLate ? "text-yellow-600" : "text-green-600"
          );

          // 출석 로그 추가
          const logEntry = document.createElement("div");
          logEntry.textContent = `${new Date().toLocaleTimeString()} - ${
            data.message
          }`;
          logEntry.classList.add(
            data.isLate ? "text-yellow-600" : "text-green-600"
          );
          attendanceLog.prepend(logEntry);
        } catch (error) {
          console.error("출석 처리 오류:", error);
          scanResult.innerText = `오류: ${error.message}`;
          scanResult.classList.remove("text-green-600", "text-blue-600");
          scanResult.classList.add("text-red-600");
        }
      }

      stopButton.addEventListener("click", () => {
        if (html5QrCode.isScanning) {
          html5QrCode.stop().then(() => {
            scanResult.innerText = "스캔이 중지되었습니다.";
            scanResult.classList.remove(
              "text-green-600",
              "text-red-600",
              "text-blue-600"
            );
            scanResult.classList.add("text-gray-600");
            stopButton.innerText = "스캔 재개";
            stopButton.classList.remove("bg-red-500", "hover:bg-red-600");
            stopButton.classList.add("bg-green-500", "hover:bg-green-600");
          });
        } else {
          html5QrCode
            .start({ facingMode: "environment" }, config, qrCodeSuccessCallback)
            .then(() => {
              scanResult.innerText = "스캔 준비 완료";
              scanResult.classList.remove("text-gray-600");
              scanResult.classList.add("text-blue-600");
              stopButton.innerText = "스캔 중지";
              stopButton.classList.remove("bg-green-500", "hover:bg-green-600");
              stopButton.classList.add("bg-red-500", "hover:bg-red-600");
            });
        }
      });
    </script>
  </body>
</html>
