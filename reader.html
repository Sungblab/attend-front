<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>완도고 출결관리 시스템</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-100 flex items-center justify-center min-h-screen">
    <div class="bg-white p-8 rounded-lg shadow-md text-center max-w-md w-full">
      <h1 class="text-2xl font-bold mb-6 text-gray-800">QR 코드 출석 확인</h1>
      <div id="qr-reader" class="mx-auto mb-4"></div>
      <div class="mb-4">
        <select id="camera-select" class="w-full p-2 border rounded">
          <option value="">카메라 선택</option>
        </select>
      </div>
      <div
        id="scan-result"
        class="text-lg font-semibold text-gray-700 mb-4"
      ></div>
      <div
        id="attendance-log"
        class="text-sm text-gray-600 mb-4 h-40 overflow-y-auto"
      ></div>
      <button
        id="start-stop-button"
        class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded"
      >
        스캔 시작
      </button>
    </div>

    <script>
      const html5QrCode = new Html5Qrcode("qr-reader");
      const scanResult = document.getElementById("scan-result");
      const attendanceLog = document.getElementById("attendance-log");
      const startStopButton = document.getElementById("start-stop-button");
      const cameraSelect = document.getElementById("camera-select");
      let lastScannedCode = "";
      let scanTimeout = null;
      let currentlyScanning = false;

      const qrCodeSuccessCallback = (decodedText, decodedResult) => {
        if (decodedText !== lastScannedCode) {
          lastScannedCode = decodedText;
          clearTimeout(scanTimeout);

          scanResult.innerText = `QR 코드 스캔 완료. 처리 중...`;
          scanResult.classList.remove("text-red-600", "text-green-600");
          scanResult.classList.add("text-blue-600");

          sendAttendance(decodedText);

          scanTimeout = setTimeout(() => {
            lastScannedCode = "";
          }, 5000);
        }
      };

      const config = { fps: 10, qrbox: { width: 250, height: 250 } };

      Html5Qrcode.getCameras()
        .then((devices) => {
          if (devices && devices.length) {
            devices.forEach((device) => {
              const option = document.createElement("option");
              option.value = device.id;
              option.text = device.label || `카메라 ${cameraSelect.length + 1}`;
              cameraSelect.add(option);
            });
          }
        })
        .catch((err) => {
          console.error("카메라 목록을 가져오는 데 실패했습니다:", err);
        });

      const userInfo = JSON.parse(localStorage.getItem("userInfo"));

      if (!userInfo || !userInfo.isReader) {
        const errorMessage = encodeURIComponent("리더 권한이 필요합니다.");
        window.location.href = `hub.html?error=${errorMessage}`;
      }

      async function sendAttendance(encryptedData) {
        try {
          const token = localStorage.getItem("token");
          const response = await fetch(
            "https://port-0-attend-backend-lz9cd9taff85e9dc.sel4.cloudtype.app/api/attendance",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
              body: JSON.stringify({ encryptedData }),
            }
          );

          const data = await response.json();

          if (!response.ok) {
            throw new Error(data.message || "출석 처리에 실패했습니다.");
          }

          console.log("출석 처리 성공:", data);
          scanResult.innerText = data.message;
          scanResult.classList.remove("text-red-600", "text-blue-600");
          scanResult.classList.add(
            data.isLate ? "text-yellow-600" : "text-green-600"
          );

          const logEntry = document.createElement("div");
          logEntry.textContent = `${new Date().toLocaleTimeString()} - ${
            data.message
          }`;
          logEntry.classList.add(
            data.isLate ? "text-yellow-600" : "text-green-600"
          );
          attendanceLog.prepend(logEntry);
        } catch (error) {
          console.error("출석 처리 오류:", error);
          scanResult.innerText = `오류: ${error.message}`;
          scanResult.classList.remove("text-green-600", "text-blue-600");
          scanResult.classList.add("text-red-600");
        }
      }

      startStopButton.addEventListener("click", () => {
        if (currentlyScanning) {
          html5QrCode.stop().then(() => {
            scanResult.innerText = "스캔이 중지되었습니다.";
            scanResult.classList.remove(
              "text-green-600",
              "text-red-600",
              "text-blue-600"
            );
            scanResult.classList.add("text-gray-600");
            startStopButton.innerText = "스캔 시작";
            startStopButton.classList.remove("bg-red-500", "hover:bg-red-600");
            startStopButton.classList.add("bg-green-500", "hover:bg-green-600");
            currentlyScanning = false;
          });
        } else {
          const selectedCameraId = cameraSelect.value;
          if (!selectedCameraId) {
            alert("카메라를 선택해주세요.");
            return;
          }
          html5QrCode
            .start(
              { deviceId: selectedCameraId },
              config,
              qrCodeSuccessCallback
            )
            .then(() => {
              scanResult.innerText = "스캔 준비 완료";
              scanResult.classList.remove("text-gray-600");
              scanResult.classList.add("text-blue-600");
              startStopButton.innerText = "스캔 중지";
              startStopButton.classList.remove(
                "bg-green-500",
                "hover:bg-green-600"
              );
              startStopButton.classList.add("bg-red-500", "hover:bg-red-600");
              currentlyScanning = true;
            });
        }
      });
    </script>
  </body>
</html>
