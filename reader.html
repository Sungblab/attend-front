<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>완도고 출결관리 시스템</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-100 flex items-center justify-center min-h-screen">
    <div class="bg-white p-8 rounded-lg shadow-md text-center max-w-md w-full">
      <h1 class="text-2xl font-bold mb-6 text-gray-800">QR 코드 출석 확인</h1>
      <div id="camera-select" class="mb-4">
        <select id="camera-list" class="w-full p-2 border rounded">
          <option value="">카메라 선택</option>
        </select>
      </div>
      <div id="qr-reader" class="mx-auto mb-4"></div>
      <div
        id="scan-result"
        class="text-lg font-semibold text-gray-700 mb-4"
      ></div>
      <div
        id="attendance-log"
        class="text-sm text-gray-600 mb-4 h-40 overflow-y-auto"
      ></div>
      <button
        id="start-button"
        class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded mr-2"
      >
        스캔 시작
      </button>
      <button
        id="stop-button"
        class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded"
      >
        스캔 중지
      </button>
    </div>

    <script>
      const html5QrCode = new Html5Qrcode("qr-reader");
      const scanResult = document.getElementById("scan-result");
      const attendanceLog = document.getElementById("attendance-log");
      const startButton = document.getElementById("start-button");
      const stopButton = document.getElementById("stop-button");
      const cameraList = document.getElementById("camera-list");
      let lastScannedCode = "";
      let scanTimeout = null;

      async function getCameras() {
        try {
          const devices = await Html5Qrcode.getCameras();
          devices.forEach((device) => {
            const option = document.createElement("option");
            option.value = device.id;
            option.text = device.label;
            cameraList.add(option);
          });
        } catch (error) {
          console.error("카메라 목록을 가져오는 데 실패했습니다:", error);
        }
      }

      getCameras();

      const qrCodeSuccessCallback = (decodedText, decodedResult) => {
        if (decodedText !== lastScannedCode) {
          lastScannedCode = decodedText;
          clearTimeout(scanTimeout);

          scanResult.innerText = `QR 코드 스캔 완료. 처리 중...`;
          scanResult.classList.remove("text-red-600", "text-green-600");
          scanResult.classList.add("text-blue-600");

          sendAttendance(decodedText);

          scanTimeout = setTimeout(() => {
            lastScannedCode = "";
          }, 5000);
        }
      };

      const config = { fps: 10, qrbox: { width: 250, height: 250 } };

      startButton.addEventListener("click", () => {
        const selectedCameraId = cameraList.value;
        if (!selectedCameraId) {
          alert("카메라를 선택해주세요.");
          return;
        }

        html5QrCode
          .start(selectedCameraId, config, qrCodeSuccessCallback)
          .then(() => {
            scanResult.innerText = "스캔 준비 완료";
            scanResult.classList.remove("text-gray-600");
            scanResult.classList.add("text-blue-600");
            startButton.disabled = true;
            stopButton.disabled = false;
          })
          .catch((err) => {
            console.error("QR 코드 스캔 시작 실패:", err);
            scanResult.innerText = `오류: ${err}`;
            scanResult.classList.add("text-red-600");
          });
      });

      stopButton.addEventListener("click", () => {
        html5QrCode
          .stop()
          .then(() => {
            scanResult.innerText = "스캔이 중지되었습니다.";
            scanResult.classList.remove(
              "text-green-600",
              "text-red-600",
              "text-blue-600"
            );
            scanResult.classList.add("text-gray-600");
            startButton.disabled = false;
            stopButton.disabled = true;
          })
          .catch((err) => {
            console.error("QR 코드 스캔 중지 실패:", err);
          });
      });

      const userInfo = JSON.parse(localStorage.getItem("userInfo"));

      if (!userInfo || !userInfo.isReader) {
        const errorMessage = encodeURIComponent("리더 권한이 필요합니다.");
        window.location.href = `hub.html?error=${errorMessage}`;
      }

      async function sendAttendance(encryptedData) {
  try {
    const token = localStorage.getItem("token");
    const response = await fetch(
      "https://port-0-attend-backend-lz9cd9taff85e9dc.sel4.cloudtype.app/api/attendance",
      {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`,
        },
        body: JSON.stringify({ encryptedData }),
      }
    );

    const data = await response.json();

    if (!response.ok) {
      throw new Error(data.message || "출석 처리에 실패했습니다.");
    }

    console.log("출석 처리 성공:", data);
    scanResult.innerText = data.message;
    scanResult.classList.remove("text-red-600", "text-blue-600", "text-yellow-600", "text-green-600");

    if (data.message.includes("결석 처리되었습니다")) {
      scanResult.classList.add("text-red-600");
    } else if (data.message.includes("지각")) {
      scanResult.classList.add("text-yellow-600");
    } else {
      scanResult.classList.add("text-green-600");
    }

    const logEntry = document.createElement("div");
    logEntry.textContent = `${new Date().toLocaleTimeString()} - ${data.message}`;
    logEntry.classList.add(
      data.message.includes("결석 처리되었습니다")
        ? "text-red-600"
        : data.message.includes("지각")
        ? "text-yellow-600"
        : "text-green-600"
    );
    attendanceLog.prepend(logEntry);
  } catch (error) {
    console.error("출석 처리 오류:", error);
    scanResult.innerText = `오류: ${error.message}`;
    scanResult.classList.remove("text-green-600", "text-blue-600", "text-yellow-600");
    scanResult.classList.add("text-red-600");
  }
}

      // 초기 상태 설정
      stopButton.disabled = true;
    </script>
  </body>
</html>
